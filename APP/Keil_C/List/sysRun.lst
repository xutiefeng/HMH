C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X2800) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          
  16          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  17          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  18          
  19          /*****************************************************
  20          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
  21          *函数功能：模拟比较器初始化
  22          *入口参数：CMPIS=正端通道，CMPRF=负端电压
  23          *出口参数：void
  24          *****************************************************/
  25          void CMP_Init(void)
  26          {
  27   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
  28   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
  29   1          IE1 |= 0x20;
  30   1      }
  31          
  32          
  33          void sysRest(void)
  34          {
  35   1         memset(gbFlagData,0,5);
  36   1         memset(&gstFilte,0,sizeof(gstFilte));
  37   1         gstAM901.stFilter = &gstFilte;
  38   1      }
  39          
  40          typedef enum
  41          {
  42            ROFilter,
  43            MixFilter
  44          }emFilter;
  45          
  46          
  47          
  48          
  49          /************************************************************************* 
  50          * 函数名称: FilterlifeTime
  51          * 功能说明: 用于计算滤芯寿命剩余时间
  52          * 输    入: 无  
  53          * 输    出: 无
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 2   

  54          *************************************************************************/
  55          void FilterlifeTime(emFilter type)
  56          {
  57   1        if( type  == ROFilter)
  58   1        {
  59   2          
  60   2          gstFilte.RO_FlowRateCnt++;
  61   2        }
  62   1        else
  63   1        {
  64   2          gstFilte.Mix_FlowRate++;
  65   2        }
  66   1      
  67   1      }
  68          
  69          void TimeReminder(void)
  70          {
  71   1        static u8 sTimeReminderCnt =0;
  72   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
  73   1        
  74   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
  75   1          temp = gstAM901.Run.Bit.DayResidualPercent;
  76   1          
  77   1        if( gstFilte.type  == ROFilter)
  78   1        {
  79   2          if(temp <1)//寿命到期
  80   2          {
  81   3              LED2_R =1;
  82   3              LED2_L =0;
  83   3          }
  84   2        
  85   2          else if(temp <3)//寿命快到期
  86   2          {
  87   3              if(sTimeReminderCnt < 5)
  88   3              {
  89   4                  LED2_R =1;
  90   4                  LED2_L =0;
  91   4              }
  92   3              else
  93   3              {
  94   4                  LED2_R =0;
  95   4                  LED2_L =0;
  96   4              }
  97   3              
  98   3              sTimeReminderCnt++;
  99   3              
 100   3              if(sTimeReminderCnt >= 10)
 101   3                sTimeReminderCnt = 0;
 102   3          }
 103   2          else
 104   2          {
 105   3              LED2_R =0;
 106   3              LED2_L =1;
 107   3          }
 108   2        }
 109   1        else
 110   1        {
 111   2          if(temp < 3)//寿命到期
 112   2          {
 113   3              LED1_R =1;
 114   3              LED1_L =0;
 115   3      
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 3   

 116   3          }
 117   2        
 118   2          else if(temp < 10)//寿命快到期
 119   2          {
 120   3              if(sTimeReminderCnt < 5)
 121   3              {
 122   4                  LED1_R =1;
 123   4                  LED1_L =0;
 124   4              }
 125   3              else
 126   3              {
 127   4                  LED1_R =0;
 128   4                  LED1_L =0;
 129   4              }
 130   3              
 131   3              sTimeReminderCnt++;
 132   3              
 133   3              if(sTimeReminderCnt >= 10)
 134   3                sTimeReminderCnt = 0;
 135   3          }
 136   2          else
 137   2          {
 138   3              LED1_R =0;
 139   3              LED1_L =1;
 140   3          }
 141   2        }
 142   1          
 143   1        
 144   1      }
 145          
 146          
 147          /************************************************************************* 
 148          * 函数名称: FilterSysRunTime
 149          * 功能说明: 用于滤芯寿命.单位秒
 150          * 输    入: 无  
 151          * 输    出: 无
 152          *************************************************************************/
 153          void FilterSysRunTime(void)
 154          {
 155   1        unsigned long  temp;
 156   1        if(gstFilte.type == ROFilter) 
 157   1        {
 158   2        
 159   2          if(gstFilte.RO_DayCnt <0x058FD400 ) //3600*24*1080 0x01E13380
 160   2            gstFilte.RO_DayCnt++;
 161   2            
 162   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 163   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 164   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 165   2          temp =  108000-temp;
 166   2          gstAM901.Run.Bit.DayResidualPercent =  (float)temp/1080;
 167   2        }
 168   1        else
 169   1        {
 170   2          if(gstFilte.Mix_DayCnt <0x01DA9C00 )//3600*24*360 
 171   2            gstFilte.Mix_DayCnt++;
 172   2            
 173   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 174   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 175   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 176   2          temp =  36000-temp; 
 177   2          gstAM901.Run.Bit.DayResidualPercent = (float)temp/360;
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 4   

 178   2        }
 179   1      //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -////
 180   1      
 181   1        
 182   1        if(gstFilte.type == ROFilter && PunpFlag) 
 183   1        {
 184   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 185   2            gstFilte.RO_FlowRateCnt++;
 186   2      
 187   2            
 188   2            
 189   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 190   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 191   2          temp =  gstFilte.RO_FlowRateCnt*0.04384;//2.63/60
 192   2          
 193   2          if(temp >10800ul )
 194   2            temp = 10800ul;
 195   2      
 196   2          gstAM901.Run.Bit.DayResidualPercent = (10800-temp)/108;
 197   2        }
 198   1        else if(gstFilte.type == MixFilter && PunpFlag)
 199   1        {
 200   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 201   2            gstFilte.Mix_FlowRate++;
 202   2            
 203   2          if(temp >3600ul )
 204   2            temp = 3600ul;
 205   2      
 206   2            
 207   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 208   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 209   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 210   2            
 211   2          gstAM901.Run.Bit.DayResidualPercent =  (3600-temp)/36;
 212   2        }
 213   1      }
 214          
 215          
 216          
 217          /************************************************************************* 
 218          * 函数名称: DevicePowerOn
 219          * 功能说明: 设备上电初始化
 220          * 输    入: 无  
 221          * 输    出: 无
 222          *************************************************************************/
 223          volatile  u8 sDPOCnt =0;nt =0;
 224          void DevicePowerOnInit(void)
 225          {
 226   1        
 227   1        Blueled_io = 1;
 228   1        Redled_io = 1;
 229   1        Chanel_IO1 = 1;
 230   1        Chanel_IO2 = 1;
 231   1        led1_io = 0;
 232   1        led2_io = 0;
 233   1        led3_io = 0;
 234   1        led4_io = 0;
 235   1        //Buzzer2Flag = 1;
 236   1        //BuzzerProcess();
 237   1        PWM_IndependentModeConfig(PWM02,2000);
 238   1        while(1)
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 5   

 239   1        {
 240   2          if(Ev100MSFlag)
 241   2          {
 242   3            WDTCON |=0x10;
 243   3            sDPOCnt++;
 244   3            Ev100MSFlag =0;
 245   3            
 246   3              
 247   3              if(sDPOCnt>= 30)
 248   3            {
 249   4              break;
 250   4            }
 251   3            else if(sDPOCnt>= 2)
 252   3            {
 253   4              PWM_IndependentModeConfig(PWM02,0);
 254   4            }       
 255   3          }
 256   2        }
 257   1        Chanel_IO1 = 0;
 258   1        Chanel_IO2 = 0;
 259   1        led1_io = 0;
 260   1        led2_io = 0;
 261   1        led3_io = 0;
 262   1        led4_io = 0;
 263   1        Blueled_io = 0;
 264   1        Redled_io = 0;
 265   1      }
 266          
 267          /************************************************************************* 
 268          * 函数名称: FirstPowerOnProcess
 269          * 功能说明: 首次上电对设备清洗处理
 270          * 输    入: 无  
 271          * 输    出: 无
 272          *************************************************************************/
 273          void FirstPowerOnProcess(void)
 274          {
 275   1          static u16 sTimeCnt = 0;
 276   1          if(!FirstPownOnFlag)
 277   1          {
 278   2              return;
 279   2          } 
 280   1          sTimeCnt++;
 281   1          JinShuiFa_io = 1;
 282   1          Pump_io = 1;
 283   1          FeiShuiFa_IO = 1;
 284   1          KongShuiFa_IO = 1;
 285   1          
 286   1          if(sTimeCnt > _15Min_Per1S)
 287   1          {
 288   2              JinShuiFa_io = 0;
 289   2              Pump_io = 0;
 290   2              FeiShuiFa_IO = 0;
 291   2              KongShuiFa_IO = 0;
 292   2              FirstPownOnFlag =  1;
 293   2          }
 294   1              
 295   1          
 296   1      }
 297          /************************************************************************* 
 298          * 函数名称: makeWaterProcess
 299          * 功能说明: 制作纯水
 300          * 输    入: 无  
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 6   

 301          * 输    出: 无
 302          *************************************************************************/
 303          
 304          
 305          void MakeWaterProcess(void)
 306          {   
 307   1          static u8 sMWaterStep = 5;
 308   1          static u16 sMWaterStepCnt = 0;
 309   1        
 310   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 311   1          {
 312   2              return;
 313   2          } 
 314   1          
 315   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 316   1          {
 317   2            sMWaterStep =   0;
 318   2            MakeWaterFlag = 1;  
 319   2            HuiLiuFa_io = 0;
 320   2          }
 321   1      
 322   1          
 323   1        
 324   1          
 325   1          switch(sMWaterStep)
 326   1          {
 327   2              case 0:
 328   2                JinShuiFa_io =1;
 329   2                sMWaterStep =1;
 330   2                LED4_L =1;
 331   2                PunpFlag = 1;
 332   2                
 333   2              break;
 334   2              
 335   2              case 1://0.5秒后打开增压泵
 336   2                sMWaterStepCnt++;
 337   2                if(sMWaterStepCnt > _500MS_Per50MS)
 338   2                {
 339   3                  sMWaterStepCnt = 0;
 340   3                  Pump_io = 1;
 341   3                  sMWaterStep++;
 342   3                }     
 343   2              break;
 344   2              
 345   2              case 2:
 346   2                if(!KeySwitchFlag)//水满
 347   2                {
 348   3                    sMWaterStep++;
 349   3                    LED4_L =0;
 350   3                }
 351   2              break;
 352   2              
 353   2              case 3:
 354   2                JinShuiFa_io = 0;//关闭进水阀
 355   2                sMWaterStepCnt = 0;
 356   2                sMWaterStep++;
 357   2                MakeWaterFlag = 0;
 358   2              break;
 359   2              
 360   2              case 4://0.5秒后关闭獗
 361   2                sMWaterStepCnt++;
 362   2                if(sMWaterStepCnt > _500MS_Per50MS)
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 7   

 363   2                {
 364   3                  sMWaterStepCnt = 0;
 365   3                  Pump_io = 0;
 366   3                  PunpFlag = 0;
 367   3                  sMWaterStep++;              
 368   3                }
 369   2              break;
 370   2              
 371   2              case 5://连续五分钟检测到水满，打开回流阀
 372   2                  
 373   2                  sMWaterStepCnt++;
 374   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 375   2                  {
 376   3                      sMWaterStepCnt = 0;
 377   3                      sMWaterStep++;    
 378   3                      
 379   3                  }
 380   2              break;
 381   2                  
 382   2              case 6:
 383   2                  sMWaterStepCnt++;
 384   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 385   2                  {
 386   3                      sMWaterStepCnt = 0;
 387   3                      sMWaterStep++;    
 388   3                      HuiLiuFa_io = 0;
 389   3                      Pump_io = 0;
 390   3                  }
 391   2                  else
 392   2                  {
 393   3                      HuiLiuFa_io = 1;
 394   3                      Pump_io = 1;//打开回流阀
 395   3                  }
 396   2                  if(KeySwitchFlag )
 397   2                    HuiLiuFa_io = 0;
 398   2              break;
 399   2                  
 400   2              default:
 401   2              break;
 402   2              
 403   2              
 404   2            }
 405   1      }
 406          
 407          
 408          void JinShuiWorkProcess(void)
 409          {
 410   1          
 411   1      }
 412          
 413          /************************************************************************* 
 414          * 函数名称: sysRuning
 415          * 功能说明: 程序运行主体
 416          * 输    入: 无  
 417          * 输    出: 无
 418          *************************************************************************/
 419          void sysRuning(void)
 420          { 
 421   1      
 422   1        EventCollect();
 423   1          switch(PopEvent())
 424   1          {    
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 8   

 425   2      
 426   2          case ev3MS:
 427   2             LED_sCan();
 428   2          break; 
 429   2              
 430   2              case ev5MS:       
 431   2                BuzzerProcess();
 432   2             //ADCollectProcess();  //  
 433   2              break;  
 434   2          
 435   2              case ev20MS:
 436   2              {
 437   3                  
 438   3              }       
 439   2              break;
 440   2              
 441   2              case ev50MS:
 442   2              {
 443   3                  KeySelect();
*** WARNING C206 IN LINE 443 OF ..\Apps\sysRun.c: 'KeySelect': missing function-prototype
 444   3                  KeyRest();
*** WARNING C206 IN LINE 444 OF ..\Apps\sysRun.c: 'KeyRest': missing function-prototype
 445   3                  KeyGaoYaSwitch();
*** WARNING C206 IN LINE 445 OF ..\Apps\sysRun.c: 'KeyGaoYaSwitch': missing function-prototype
 446   3                  MakeWaterProcess();           
 447   3              }
 448   2              break;
 449   2              
 450   2              case ev100MS:
 451   2              {
 452   3                  LED_Process();  
 453   3                  TimeReminder();
 454   3                  ////EepromProcess();   
 455   3              }
 456   2              break;
 457   2              
 458   2              case ev1S:
 459   2              {
 460   3                  FilterSysRunTime();//滤芯寿命计算
 461   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 462   3              }
 463   2              break;
 464   2         
 465   2              default:
 466   2              break;
 467   2          }
 468   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1412    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      9       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 09:11:11 PAGE 9   


C51 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
