C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(0,SIZE) BROWSE INTVECTOR(0X1000) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          
  16          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  17          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  18          
  19          
  20          #define STEP_1()  Pump_io =1;LED1_L=1;sFactoryStep++
  21          #define STEP_2()  JinShuiFa_io =1;LED2_L=1;sFactoryStep++
  22          #define STEP_3()  FeiShuiFa_IO =1;LED4_L=1;sFactoryStep++
  23          #define STEP_4()  HuiLiuFa_io =1;LED3_L=1;sFactoryStep++
  24          #define STEP_5()  KongShuiFa_IO =1;LED4_R=1;sFactoryStep++
  25          
  26          #define STEP_6()  BlueLedFlag =1;RedLedtFlag =1;gbFlagData[3].all =0XFF;Buzzer5Flag =1;sFactoryStep++
  27          #define STEP_7()  sFactoryStep++;
  28          extern void setLED(u8 num,emColor color ,U_LED state,u8 time);
  29          
  30          void FactoryProcess(void)
  31          {
  32   1        static u16 FactoryPeriodCnt = 0;
  33   1          
  34   1        static u8 sFactoryStep =0;
  35   1      
  36   1        FactoryPeriodCnt++;
  37   1      
  38   1        if(!FactoryModeFlag)
  39   1        {
  40   2          
  41   2          return ;
  42   2        }
  43   1      
  44   1        if(FactoryModeFlag^HisFactoryModeFlag)
  45   1        {
  46   2          sFactoryStep =0;
  47   2          HisFactoryModeFlag = FactoryModeFlag;
  48   2          
  49   2          gbFlagData[3].all = 0;
  50   2          Buzzer5Flag = 0;
  51   2          RedLedtFlag = 0;
  52   2        }
  53   1      
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 2   

  54   1        if(FactoryPeriodCnt%2 == 0)
  55   1        {
  56   2          switch(sFactoryStep)
  57   2          {
  58   3            case 0:
  59   3              STEP_1();
  60   3            break;
  61   3      
  62   3            case 1:
  63   3              STEP_2();
  64   3            break;
  65   3      
  66   3            case 2:
  67   3              STEP_3();
  68   3            break;
  69   3      
  70   3            case 3:
  71   3              STEP_4();
  72   3            break;
  73   3      
  74   3            case 4:
  75   3              STEP_5();
  76   3            break;
  77   3      
  78   3            case 5:
  79   3              STEP_6();
  80   3            break;
  81   3      
  82   3            case 6:
  83   3              STEP_7();
  84   3            break;
  85   3      
  86   3            case 7:
  87   3              gbFlagData[3].all = 0;
  88   3              BlueLedFlag = 0;
  89   3              RedLedtFlag = 0;
  90   3              JinShuiFa_io = 0;
  91   3              FeiShuiFa_IO = 0;
  92   3              HuiLiuFa_io = 0;
  93   3              KongShuiFa_IO = 0;
  94   3              sFactoryStep++;
  95   3            break;
  96   3      
  97   3            case 8:
  98   3               FstModeFlag = 1;
  99   3               FactoryModeFlag =0;
 100   3            break;
 101   3            
 102   3            
 103   3      
 104   3            default:
 105   3              break;
 106   3            
 107   3          }
 108   2        }
 109   1        
 110   1      }
 111          
 112          
 113          
 114          /*****************************************************
 115          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 3   

 116          *函数功能：模拟比较器初始化
 117          *入口参数：CMPIS=正端通道，CMPRF=负端电压
 118          *出口参数：void
 119          *****************************************************/
 120          void CMP_Init(void)
 121          {
 122   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
 123   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
 124   1          IE1 |= 0x20;
 125   1      }
 126          
 127          
 128          void sysRest(void)
 129          {
 130   1         memset(gbFlagData,0,10);
 131   1         memset(&gstFilte,0,sizeof(gstFilte));
 132   1         memset(&gstAM901,0,sizeof(gstAM901));
 133   1         memset(&gstRDsysTick,0,sizeof(gstRDsysTick));
 134   1         gstAM901.stFilter = &gstFilte;
 135   1      }
 136          
 137          
 138          
 139          
 140          
 141          /************************************************************************* 
 142          * 函数名称: FilterlifeTime
 143          * 功能说明: 用于计算滤芯寿命剩余时间
 144          * 输    入: 无  
 145          * 输    出: 无
 146          *************************************************************************/
 147          void FilterlifeTime(emFilter type)
 148          {
 149   1        if(FstModeFlag)
 150   1        {
 151   2          if( type  == ROFilter)
 152   2          {     
 153   3            gstFilte.RO_FlowRateCnt+=600ul;
 154   3          }
 155   2          else
 156   2          {
 157   3            gstFilte.Mix_FlowRate+=600ul;
 158   3          }
 159   2        }
 160   1        else
 161   1        {
 162   2      
 163   2          if( type  == ROFilter)
 164   2          {
 165   3            
 166   3            gstFilte.RO_FlowRateCnt++;
 167   3          }
 168   2          else
 169   2          {
 170   3            gstFilte.Mix_FlowRate++;
 171   3          }
 172   2        }
 173   1        
 174   1      
 175   1      }
 176          
 177          void FilterlifeDayTime(emFilter type)
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 4   

 178          {
 179   1        if(FstModeFlag)
 180   1        {
 181   2          if( type  == ROFilter)
 182   2          {
 183   3            gstFilte.RO_DayCnt+=86400ul;
 184   3          }
 185   2          else
 186   2          {
 187   3            gstFilte.Mix_DayCnt+=86400ul;
 188   3          }
 189   2        }
 190   1        else
 191   1        {
 192   2          if( type  == ROFilter)
 193   2          {
 194   3            
 195   3            gstFilte.RO_DayCnt++;
 196   3          }
 197   2          else
 198   2          {
 199   3            gstFilte.Mix_DayCnt++;
 200   3          }
 201   2        }
 202   1        
 203   1      
 204   1      }
 205          
 206          
 207          /************************************************************************* 
 208          * 函数名称: TimeReminder
 209          * 功能说明: 寿命到期处理
 210          * 输    入: 无  
 211          * 输    出: 无
 212          *************************************************************************/
 213          
 214          
 215          
 216          void TimeReminder(void)
 217          {
 218   1        static ST_TimeReminder sTimeReminderCnt ={0};
 219   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
 220   1      
 221   1        if(FactoryModeFlag ||!SysRunFlag)
 222   1        {
 223   2          return ;
 224   2        }
 225   1       
 226   1        
 227   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
 228   1          temp = gstAM901.Run.Bit.DayResidualPercent;
 229   1        
 230   1          
 231   1        if( gstFilte.type  == ROFilter)
 232   1        {
 233   2          LED1_R =0;
 234   2          LED1_L =0;
 235   2          if(temp <= 1)//寿命到期
 236   2          {
 237   3              if(!sTimeReminderCnt.Bit.buzeerOn1 && KeySwitchFlag1 && ShuiLongTouOpen)
 238   3              {
 239   4                sTimeReminderCnt.Bit.buzeerOn = 0;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 5   

 240   4                sTimeReminderCnt.Bit.buzeerOn1 = 1;
 241   4                Buzzer1Flag = 1;
 242   4              }
 243   3              LED2_R =1;
 244   3              LED2_L =0;  
 245   3          }
 246   2        
 247   2          else if(temp <=3)//寿命快到期
 248   2          {
 249   3          
 250   3      
 251   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1&& ShuiLongTouOpen)
 252   3              {
 253   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 254   4                sTimeReminderCnt.Bit.buzeerOn1 = 0;
 255   4                Buzzer4Flag = 1;
 256   4              }
 257   3              
 258   3              if(sTimeReminderCnt.Bit.cnt <= 5)
 259   3              {
 260   4                  LED2_R =1;
 261   4                  LED2_L =0;
 262   4              }
 263   3              else
 264   3              {
 265   4                  LED2_R =0;
 266   4                  LED2_L =0;
 267   4              }
 268   3              
 269   3              sTimeReminderCnt.Bit.cnt++;
 270   3              
 271   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 272   3                sTimeReminderCnt.Bit.cnt = 0;
 273   3              
 274   3          }
 275   2          else
 276   2          {
 277   3              //LED2_R =0;
 278   3              //LED2_L =1;
 279   3              setLED(2,BlueColor,lightOn,0);
 280   3              
 281   3          }
 282   2        }
 283   1        else
 284   1        {
 285   2          
 286   2          LED2_R =0;
 287   2          LED2_L =0;
 288   2          if(temp <= 3)//寿命到期
 289   2          {
 290   3              LED1_R =1;
 291   3              LED1_L =0;
 292   3                
 293   3              if(!sTimeReminderCnt.Bit.buzeerOn1 && KeySwitchFlag1&& ShuiLongTouOpen)
 294   3              {
 295   4                sTimeReminderCnt.Bit.buzeerOn = 0;
 296   4                sTimeReminderCnt.Bit.buzeerOn1 = 1;
 297   4                Buzzer1Flag = 1;
 298   4              }
 299   3      
 300   3          }
 301   2        
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 6   

 302   2          else if(temp <= 10)//寿命快到期
 303   2          {
 304   3      
 305   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1&& ShuiLongTouOpen)
 306   3              {
 307   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 308   4                sTimeReminderCnt.Bit.buzeerOn1 = 0;
 309   4                Buzzer4Flag = 1;
 310   4              }
 311   3              
 312   3              if(sTimeReminderCnt.Bit.cnt < 5)
 313   3              {
 314   4                  LED1_R =1;
 315   4                  LED1_L =0;
 316   4              }
 317   3              else
 318   3              {
 319   4                  LED1_R =0;
 320   4                  LED1_L =0;
 321   4              }
 322   3              
 323   3              sTimeReminderCnt.Bit.cnt++;
 324   3              
 325   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 326   3                sTimeReminderCnt.Bit.cnt = 0;
 327   3          }
 328   2          else
 329   2          {
 330   3              //LED1_R =0;
 331   3              //LED1_L =1;
 332   3              setLED(1,BlueColor,lightOn,0);
 333   3          }
 334   2        }
 335   1          
 336   1        
 337   1      }
 338          
 339          
 340          /************************************************************************* 
 341          * 函数名称: FilterSysRunTime
 342          * 功能说明: 用于滤芯寿命.单位秒
 343          * 输    入: 无  
 344          * 输    出: 无
 345          *************************************************************************/
 346          
 347          #define RO_DAY 1080ul
 348          #define MIX_3INI_DAY 360ul
 349          void FilterSysRunTime(void)
 350          {
 351   1         unsigned long  temp;
 352   1         float ftemp;
 353   1        if(gstFilte.type == ROFilter) 
 354   1        {
 355   2        /* 测试使用
 356   2          百分之2   90514640
 357   2          百分之3   0x5651D00
 358   2          百分之10  0x5017200
 359   2          
 360   2          */
 361   2          if(gstFilte.RO_DayCnt <0x058FD400 ) //3600*24*1080 0x01E13380
 362   2            FilterlifeDayTime();
*** WARNING C209 IN LINE 362 OF ..\Apps\sysRun.c: '_FilterlifeDayTime': too few actual parameters
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 7   

 363   2            
 364   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 365   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 366   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 367   2            
 368   2          if(temp < 108000ul)
 369   2          {
 370   3            temp = 108000ul-temp;
 371   3            ftemp = (float)temp/1080ul;
 372   3            gstAM901.Run.Bit.DayResidualPercent =  (u8)ftemp;
 373   3          }
 374   2          
 375   2          
 376   2        }
 377   1        else
 378   1        {
 379   2          /* 测试使用
 380   2          百分之3   0x01C9CE63
 381   2          百分之10   0x1AB2600
 382   2          百分之90  3110405
 383   2          */
 384   2          if(gstFilte.Mix_DayCnt <0x01DA9C00 )//3600*24*360 
 385   2            FilterlifeDayTime();
*** WARNING C209 IN LINE 385 OF ..\Apps\sysRun.c: '_FilterlifeDayTime': too few actual parameters
 386   2            
 387   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 388   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 389   2          temp =  gstFilte.Mix_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 390   2          temp =  36000ul-temp; 
 391   2      
 392   2          ftemp = (float)temp/MIX_3INI_DAY;
 393   2          gstAM901.Run.Bit.DayResidualPercent = (u8)ftemp;
 394   2        }
 395   1      ///////////////////////////////////////////////////MIX_RO_DAY/////////////////////////////////////////////
             -//////////////
 396   1      
 397   1        
 398   1        if(gstFilte.type == ROFilter && PunpFlag) 
 399   1        {
 400   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 401   2            FilterlifeTime();
*** WARNING C209 IN LINE 401 OF ..\Apps\sysRun.c: '_FilterlifeTime': too few actual parameters
 402   2      
 403   2          /* 测试使用
 404   2          百分之1   90514640
 405   2          百分之3   0x5651D00
 406   2          百分之100  246388ul
 407   2          
 408   2          */  
 409   2            
 410   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 411   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 412   2          temp =  (float)gstFilte.RO_FlowRateCnt*0.04384;//2.63/60;//
 413   2          if(temp >10800ul )
 414   2            temp = 10800ul;
 415   2          
 416   2          temp =  10800-temp; 
 417   2      
 418   2          ftemp = (float)temp/108;
 419   2      
 420   2          gstAM901.Run.Bit.FlowResidualPercent = (u8)ftemp;
 421   2        }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 8   

 422   1        else if(gstFilte.type == MixFilter && PunpFlag)
 423   1        {
 424   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 425   2            FilterlifeTime();;
*** WARNING C209 IN LINE 425 OF ..\Apps\sysRun.c: '_FilterlifeTime': too few actual parameters
 426   2            
 427   2          
 428   2      
 429   2            
 430   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 431   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 432   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 433   2          
 434   2          if(temp >3600ul )
 435   2            temp = 3600ul;
 436   2          
 437   2          temp =  3600-temp;  
 438   2      
 439   2          ftemp = ((float)temp)/36;
 440   2            
 441   2          gstAM901.Run.Bit.FlowResidualPercent =  (u8)ftemp;
 442   2        }
 443   1      }
 444          
 445           
 446          
 447          /************************************************************************* 
 448          * 函数名称: DevicePowerOn
 449          * 功能说明: 设备上电初始化
 450          * 输    入: 无  
 451          * 输    出: 无
 452          *************************************************************************/
 453          volatile  u8 sDPOCnt =0;nt =0;
 454          void DevicePowerOnInit(void)
 455          {
 456   1        
 457   1        Blueled_io = 1;
 458   1        Redled_io = 1;
 459   1        Chanel_IO1 = 1;
 460   1        Chanel_IO2 = 1;
 461   1        led1_io = 0;
 462   1        led2_io = 0;
 463   1        led3_io = 0;
 464   1        led4_io = 0;
 465   1        //Buzzer2Flag = 1;
 466   1        //BuzzerProcess();
 467   1        PWM_IndependentModeConfig(PWM02,2000);
 468   1        while(1)
 469   1        {
 470   2          if(Ev100MSFlag)
 471   2          {
 472   3            WDTCON |=0x10;
 473   3            sDPOCnt++;
 474   3            Ev100MSFlag =0;
 475   3            
 476   3              
 477   3             if(sDPOCnt>= 30)
 478   3            {
 479   4              break;
 480   4            }
 481   3            else if(sDPOCnt>= 2)
 482   3            {
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 9   

 483   4              PWM_IndependentModeConfig(PWM02,0);
 484   4            }       
 485   3          }
 486   2        }
 487   1        Chanel_IO1 = 0;
 488   1        Chanel_IO2 = 0;
 489   1        led1_io = 0;
 490   1        led2_io = 0;
 491   1        led3_io = 0;
 492   1        led4_io = 0;
 493   1        Blueled_io = 0;
 494   1        Redled_io = 0;
 495   1      }
 496          
 497          /************************************************************************* 
 498          * 函数名称: FirstPowerOnProcess
 499          * 功能说明: 首次上电对设备清洗处理
 500          * 输    入: 无  
 501          * 输    出: 无
 502          *************************************************************************/
 503          void FirstPowerOnProcess(void)
 504          {
 505   1          static u16 sTimeCnt = 0;
 506   1          if(!FirstPownOnFlag)
 507   1          {
 508   2              return;
 509   2          } 
 510   1          sTimeCnt++;
 511   1          JinShuiFa_io = 1;
 512   1          Pump_io = 1;
 513   1          FeiShuiFa_IO = 1;
 514   1          KongShuiFa_IO = 1;
 515   1          
 516   1          if(sTimeCnt > _15Min_Per1S)
 517   1          {
 518   2              JinShuiFa_io = 0;
 519   2              Pump_io = 0;
 520   2              FeiShuiFa_IO = 0;
 521   2              KongShuiFa_IO = 0;
 522   2              FirstPownOnFlag =  1;
 523   2          }
 524   1              
 525   1          
 526   1      }
 527          /************************************************************************* 
 528          * 函数名称: RestFilter
 529          * 功能说明: 复位滤芯
 530          * 输    入: 无  
 531          * 输    出: 无
 532          *************************************************************************/
 533          void RestFilter(void)
 534          {
 535   1      
 536   1      }
 537          
 538          /************************************************************************* 
 539          * 函数名称: makeWaterProcess
 540          * 功能说明: 制作纯水
 541          * 输    入: 无  
 542          * 输    出: 无
 543          *************************************************************************/
 544          
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 10  

 545          
 546          void MakeWaterProcess(void)
 547          {   
 548   1          static u8 sMWaterStep = 5;
 549   1          static u16 sMWaterStepCnt = 0;
 550   1      
 551   1          if(FactoryModeFlag)
 552   1          {
 553   2            return ;
 554   2          }
 555   1        
 556   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 557   1          {
 558   2              return;
 559   2          } 
 560   1          
 561   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 562   1          {
 563   2            sMWaterStep =   0;
 564   2            MakeWaterFlag = 1;  
 565   2            HuiLiuFa_io = 0;
 566   2          }
 567   1      
 568   1          
 569   1        
 570   1          
 571   1          switch(sMWaterStep)
 572   1          {
 573   2              case 0:
 574   2                JinShuiFa_io =1;
 575   2                sMWaterStep =1;
 576   2                LED4_L =1;
 577   2                PunpFlag = 1;
 578   2                
 579   2              break;
 580   2              
 581   2              case 1://0.5秒后打开增压泵
 582   2                sMWaterStepCnt++;
 583   2                if(sMWaterStepCnt > _500MS_Per50MS)
 584   2                {
 585   3                  sMWaterStepCnt = 0;
 586   3                  Pump_io = 1;
 587   3                  sMWaterStep++;
 588   3                  ChuShuiFlag = 1;
 589   3                }     
 590   2              break;
 591   2              
 592   2              case 2:
 593   2                if(!KeySwitchFlag)//水满
 594   2                {
 595   3                    sMWaterStep++;
 596   3                    LED4_L =0;
 597   3                }
 598   2              break;
 599   2              
 600   2              case 3:
 601   2                JinShuiFa_io = 0;//关闭进水阀
 602   2                sMWaterStepCnt = 0;
 603   2                sMWaterStep++;
 604   2                MakeWaterFlag = 0;
 605   2              break;
 606   2              
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 11  

 607   2              case 4://0.5秒后关闭獗
 608   2                sMWaterStepCnt++;
 609   2                if(sMWaterStepCnt > _500MS_Per50MS)
 610   2                {
 611   3                  sMWaterStepCnt = 0;
 612   3                  Pump_io = 0;
 613   3                  PunpFlag = 0;
 614   3                  sMWaterStep++;      
 615   3                  ChuShuiFlag = 0;
 616   3                }
 617   2              break;
 618   2              
 619   2              case 5://连续五分钟检测到水满，打开回流阀
 620   2                  
 621   2                  sMWaterStepCnt++;
 622   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 623   2                  {
 624   3                      sMWaterStepCnt = 0;
 625   3                      sMWaterStep++;    
 626   3                      
 627   3                  }
 628   2              break;
 629   2                  
 630   2              case 6:
 631   2                  sMWaterStepCnt++;
 632   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 633   2                  {
 634   3                      sMWaterStepCnt = 0;
 635   3                      sMWaterStep++;    
 636   3                      HuiLiuFa_io = 0;
 637   3                      Pump_io = 0;
 638   3                  }
 639   2                  else
 640   2                  {
 641   3                      HuiLiuFa_io = 1;
 642   3                      Pump_io = 1;//打开回流阀
 643   3                  }
 644   2                  if(KeySwitchFlag )
 645   2                    HuiLiuFa_io = 0;
 646   2              break;
 647   2                  
 648   2              default:
 649   2              break;
 650   2              
 651   2              
 652   2            }
 653   1      }
 654          
 655          // TDS值校准
 656          
 657          void TDS_JiaoZhun(u16 v0,u16 AdValue_0,u16 v1,u16 AdValue_1)
 658          {
 659   1        float a,b;
 660   1      
 661   1        
 662   1          if(v0 > v1)
 663   1          {
 664   2            //  a = (v0- v1)*4095/((float)(AdValue_0-AdValue_1));
 665   2              a= (v0- v1);
 666   2              a= a*4095/(float)(AdValue_0-AdValue_1);
 667   2              b = AdValue_1/(float)4095;
 668   2              b = b*a;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 12  

 669   2              b =  v1- b;
 670   2          }
 671   1          else
 672   1          {
 673   2              
 674   2              
 675   2            
 676   2              a= (v1- v0);
 677   2              a= a*4095/(float)(AdValue_1-AdValue_0);
 678   2              b = AdValue_1/(float)4095;
 679   2              b = b*a;
 680   2              b =  v1- b;
 681   2              return;
 682   2          }
 683   1        
 684   1      }
 685          
 686          
 687          /************************************************************************* 
 688          * 函数名称: sysRuning
 689          * 功能说明: 程序运行主体
 690          * 输    入: 无  
 691          * 输    出: 无
 692          *************************************************************************/
 693          extern void TDS_Calulate(void);
 694          extern  void KeyGaoYaSwitch(void);
 695          extern void KeyRest(void);
 696          extern void KeySelect(void);
 697          u16 gPPM1 = 110 ,gPPM2 = 50 ,gAD1 = 1420 ,gAD2 =1120;
 698          void sysRuning(void)
 699          { 
 700   1      
 701   1        EventCollect();
 702   1          switch(PopEvent())
 703   1          {    
 704   2          
 705   2              case ev5MS:       
 706   2                BuzzerProcess();  
 707   2                
 708   2              break;  
 709   2      
 710   2              
 711   2              case ev50MS:
 712   2              {
 713   3                  KeySelect();
 714   3                  KeyRest();
 715   3                  NoKeyProcess();
*** WARNING C206 IN LINE 715 OF ..\Apps\sysRun.c: 'NoKeyProcess': missing function-prototype
 716   3                  KeyGaoYaSwitch();
 717   3                  MakeWaterProcess(); 
 718   3                  
 719   3              }
 720   2              break;
 721   2              
 722   2              case ev100MS:
 723   2              {
 724   3                  
 725   3                  TimeReminder();
 726   3                  TDS_Calulate();
 727   3                  UART0_SendData(); 
 728   3                  LED_Process();  
 729   3              }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/02/2024 20:37:53 PAGE 13  

 730   2              break;
 731   2              
 732   2              case ev1S:
 733   2              {
 734   3                  TDS_JiaoZhun(gPPM1,gAD1,gPPM2,gAD2);
 735   3                  FilterSysRunTime();//滤芯寿命计算
 736   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 737   3                  FactoryProcess();
 738   3                  SysRunFlag =1;
 739   3                  PaiShuiProcess();
*** WARNING C206 IN LINE 739 OF ..\Apps\sysRun.c: 'PaiShuiProcess': missing function-prototype
 740   3              }
 741   2              break;
 742   2         
 743   2              default:
 744   2              break;
 745   2          }
 746   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3593    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     47    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  6 WARNING(S),  0 ERROR(S)
