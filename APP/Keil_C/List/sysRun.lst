C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(0,SIZE) BROWSE INTVECTOR(0X2800) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          
  16          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  17          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  18          
  19          /*****************************************************
  20          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
  21          *函数功能：模拟比较器初始化
  22          *入口参数：CMPIS=正端通道，CMPRF=负端电压
  23          *出口参数：void
  24          *****************************************************/
  25          void CMP_Init(void)
  26          {
  27   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
  28   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
  29   1          IE1 |= 0x20;
  30   1      }
  31          
  32          
  33          void sysRest(void)
  34          {
  35   1         memset(gbFlagData,0,5);
  36   1         memset(&gstFilte,0,sizeof(gstFilte));
  37   1         memset(&gstAM901,0,sizeof(gstAM901));
  38   1         gstAM901.stFilter = &gstFilte;
  39   1      }
  40          
  41          typedef enum
  42          {
  43            ROFilter,
  44            MixFilter
  45          }emFilter;
  46          
  47          
  48          
  49          
  50          /************************************************************************* 
  51          * 函数名称: FilterlifeTime
  52          * 功能说明: 用于计算滤芯寿命剩余时间
  53          * 输    入: 无  
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 2   

  54          * 输    出: 无
  55          *************************************************************************/
  56          void FilterlifeTime(emFilter type)
  57          {
  58   1        if( type  == ROFilter)
  59   1        {
  60   2          
  61   2          gstFilte.RO_FlowRateCnt++;
  62   2        }
  63   1        else
  64   1        {
  65   2          gstFilte.Mix_FlowRate++;
  66   2        }
  67   1      
  68   1      }
  69          
  70          void TimeReminder(void)
  71          {
  72   1        static u8 sTimeReminderCnt =0;
  73   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
  74   1        
  75   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
  76   1          temp = gstAM901.Run.Bit.DayResidualPercent;
  77   1          
  78   1        if( gstFilte.type  == ROFilter)
  79   1        {
  80   2          if(temp <1)//寿命到期
  81   2          {
  82   3              LED2_R =1;
  83   3              LED2_L =0;
  84   3          }
  85   2        
  86   2          else if(temp <=3)//寿命快到期
  87   2          {
  88   3              if(sTimeReminderCnt <= 5)
  89   3              {
  90   4                  LED2_R =1;
  91   4                  LED2_L =0;
  92   4              }
  93   3              else
  94   3              {
  95   4                  LED2_R =0;
  96   4                  LED2_L =0;
  97   4              }
  98   3              
  99   3              sTimeReminderCnt++;
 100   3              
 101   3              if(sTimeReminderCnt >= 10)
 102   3                sTimeReminderCnt = 0;
 103   3          }
 104   2          else
 105   2          {
 106   3              LED2_R =0;
 107   3              LED2_L =1;
 108   3          }
 109   2        }
 110   1        else
 111   1        {
 112   2          if(temp <= 3)//寿命到期
 113   2          {
 114   3              LED1_R =1;
 115   3              LED1_L =0;
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 3   

 116   3      
 117   3          }
 118   2        
 119   2          else if(temp <= 10)//寿命快到期
 120   2          {
 121   3              if(sTimeReminderCnt < 5)
 122   3              {
 123   4                  LED1_R =1;
 124   4                  LED1_L =0;
 125   4              }
 126   3              else
 127   3              {
 128   4                  LED1_R =0;
 129   4                  LED1_L =0;
 130   4              }
 131   3              
 132   3              sTimeReminderCnt++;
 133   3              
 134   3              if(sTimeReminderCnt >= 10)
 135   3                sTimeReminderCnt = 0;
 136   3          }
 137   2          else
 138   2          {
 139   3              LED1_R =0;
 140   3              LED1_L =1;
 141   3          }
 142   2        }
 143   1          
 144   1        
 145   1      }
 146          
 147          
 148          /************************************************************************* 
 149          * 函数名称: FilterSysRunTime
 150          * 功能说明: 用于滤芯寿命.单位秒
 151          * 输    入: 无  
 152          * 输    出: 无
 153          *************************************************************************/
 154          
 155          #define RO_DAY 1080ul
 156          #define MIX_3INI_DAY 360ul
 157          void FilterSysRunTime(void)
 158          {
 159   1         unsigned long  temp;
 160   1         float ftemp;
 161   1        if(gstFilte.type == ROFilter) 
 162   1        {
 163   2        /* 测试使用
 164   2          百分之2   90514640
 165   2          百分之3   0x5651D00
 166   2          百分之10  0x5017200
 167   2          
 168   2          */
 169   2          if(gstFilte.RO_DayCnt <0x058FD400 ) //3600*24*1080 0x01E13380
 170   2            gstFilte.RO_DayCnt++;
 171   2            
 172   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 173   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 174   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 175   2            
 176   2          if(temp < 108000ul)
 177   2          {
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 4   

 178   3            temp = 108000ul-temp;
 179   3            ftemp = (float)temp/1080ul;
 180   3            gstAM901.Run.Bit.DayResidualPercent =  (u8)ftemp;
 181   3          }
 182   2          
 183   2          
 184   2        }
 185   1        else
 186   1        {
 187   2          /* 测试使用
 188   2          百分之3   0x01C9CE63
 189   2          百分之10   0x1AB2600
 190   2          百分之90  3110405
 191   2          */
 192   2          if(gstFilte.Mix_DayCnt <0x01DA9C00 )//3600*24*360 
 193   2            gstFilte.Mix_DayCnt++;
 194   2            
 195   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 196   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 197   2          temp =  gstFilte.Mix_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 198   2          temp =  36000ul-temp; 
 199   2      
 200   2          ftemp = (float)temp/MIX_3INI_DAY;
 201   2          gstAM901.Run.Bit.DayResidualPercent = (u8)ftemp;
 202   2        }
 203   1      ///////////////////////////////////////////////////MIX_RO_DAY/////////////////////////////////////////////
             -//////////////
 204   1      
 205   1        
 206   1        if(gstFilte.type == ROFilter && PunpFlag) 
 207   1        {
 208   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 209   2            gstFilte.RO_FlowRateCnt++;
 210   2      
 211   2          /* 测试使用
 212   2          百分之1   90514640
 213   2          百分之3   0x5651D00
 214   2          百分之100  246388ul
 215   2          
 216   2          */  
 217   2            
 218   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 219   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 220   2          temp =  (float)gstFilte.RO_FlowRateCnt*0.04384;//2.63/60;//
 221   2          if(temp >10800ul )
 222   2            temp = 10800ul;
 223   2          
 224   2          temp =  10800-temp; 
 225   2      
 226   2          ftemp = (float)temp/108;
 227   2      
 228   2          gstAM901.Run.Bit.FlowResidualPercent = (u8)ftemp;
 229   2        }
 230   1        else if(gstFilte.type == MixFilter && PunpFlag)
 231   1        {
 232   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 233   2            gstFilte.Mix_FlowRate++;
 234   2            
 235   2          
 236   2      
 237   2            
 238   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 5   

 239   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 240   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 241   2          
 242   2          if(temp >3600ul )
 243   2            temp = 3600ul;
 244   2          
 245   2          temp =  3600-temp;  
 246   2      
 247   2          ftemp = ((float)temp)/36;
 248   2            
 249   2          gstAM901.Run.Bit.FlowResidualPercent =  (u8)ftemp;
 250   2        }
 251   1      }
 252          
 253          void LEDProcess(void)
 254          {
 255   1          if(!FirstPownOnFlag)
 256   1          {
 257   2              return;
 258   2          } 
 259   1      }
 260          
 261          /************************************************************************* 
 262          * 函数名称: DevicePowerOn
 263          * 功能说明: 设备上电初始化
 264          * 输    入: 无  
 265          * 输    出: 无
 266          *************************************************************************/
 267          volatile  u8 sDPOCnt =0;nt =0;
 268          void DevicePowerOnInit(void)
 269          {
 270   1        
 271   1        Blueled_io = 1;
 272   1        Redled_io = 1;
 273   1        Chanel_IO1 = 1;
 274   1        Chanel_IO2 = 1;
 275   1        led1_io = 0;
 276   1        led2_io = 0;
 277   1        led3_io = 0;
 278   1        led4_io = 0;
 279   1        //Buzzer2Flag = 1;
 280   1        //BuzzerProcess();
 281   1        PWM_IndependentModeConfig(PWM02,2000);
 282   1        while(1)
 283   1        {
 284   2          if(Ev100MSFlag)
 285   2          {
 286   3            WDTCON |=0x10;
 287   3            sDPOCnt++;
 288   3            Ev100MSFlag =0;
 289   3            
 290   3              
 291   3              if(sDPOCnt>= 30)
 292   3            {
 293   4              break;
 294   4            }
 295   3            else if(sDPOCnt>= 2)
 296   3            {
 297   4              PWM_IndependentModeConfig(PWM02,0);
 298   4            }       
 299   3          }
 300   2        }
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 6   

 301   1        Chanel_IO1 = 0;
 302   1        Chanel_IO2 = 0;
 303   1        led1_io = 0;
 304   1        led2_io = 0;
 305   1        led3_io = 0;
 306   1        led4_io = 0;
 307   1        Blueled_io = 0;
 308   1        Redled_io = 0;
 309   1      }
 310          
 311          /************************************************************************* 
 312          * 函数名称: FirstPowerOnProcess
 313          * 功能说明: 首次上电对设备清洗处理
 314          * 输    入: 无  
 315          * 输    出: 无
 316          *************************************************************************/
 317          void FirstPowerOnProcess(void)
 318          {
 319   1          static u16 sTimeCnt = 0;
 320   1          if(!FirstPownOnFlag)
 321   1          {
 322   2              return;
 323   2          } 
 324   1          sTimeCnt++;
 325   1          JinShuiFa_io = 1;
 326   1          Pump_io = 1;
 327   1          FeiShuiFa_IO = 1;
 328   1          KongShuiFa_IO = 1;
 329   1          
 330   1          if(sTimeCnt > _15Min_Per1S)
 331   1          {
 332   2              JinShuiFa_io = 0;
 333   2              Pump_io = 0;
 334   2              FeiShuiFa_IO = 0;
 335   2              KongShuiFa_IO = 0;
 336   2              FirstPownOnFlag =  1;
 337   2          }
 338   1              
 339   1          
 340   1      }
 341          /************************************************************************* 
 342          * 函数名称: makeWaterProcess
 343          * 功能说明: 制作纯水
 344          * 输    入: 无  
 345          * 输    出: 无
 346          *************************************************************************/
 347          
 348          
 349          void MakeWaterProcess(void)
 350          {   
 351   1          static u8 sMWaterStep = 5;
 352   1          static u16 sMWaterStepCnt = 0;
 353   1        
 354   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 355   1          {
 356   2              return;
 357   2          } 
 358   1          
 359   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 360   1          {
 361   2            sMWaterStep =   0;
 362   2            MakeWaterFlag = 1;  
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 7   

 363   2            HuiLiuFa_io = 0;
 364   2          }
 365   1      
 366   1          
 367   1        
 368   1          
 369   1          switch(sMWaterStep)
 370   1          {
 371   2              case 0:
 372   2                JinShuiFa_io =1;
 373   2                sMWaterStep =1;
 374   2                LED4_L =1;
 375   2                PunpFlag = 1;
 376   2                
 377   2              break;
 378   2              
 379   2              case 1://0.5秒后打开增压泵
 380   2                sMWaterStepCnt++;
 381   2                if(sMWaterStepCnt > _500MS_Per50MS)
 382   2                {
 383   3                  sMWaterStepCnt = 0;
 384   3                  Pump_io = 1;
 385   3                  sMWaterStep++;
 386   3                }     
 387   2              break;
 388   2              
 389   2              case 2:
 390   2                if(!KeySwitchFlag)//水满
 391   2                {
 392   3                    sMWaterStep++;
 393   3                    LED4_L =0;
 394   3                }
 395   2              break;
 396   2              
 397   2              case 3:
 398   2                JinShuiFa_io = 0;//关闭进水阀
 399   2                sMWaterStepCnt = 0;
 400   2                sMWaterStep++;
 401   2                MakeWaterFlag = 0;
 402   2              break;
 403   2              
 404   2              case 4://0.5秒后关闭獗
 405   2                sMWaterStepCnt++;
 406   2                if(sMWaterStepCnt > _500MS_Per50MS)
 407   2                {
 408   3                  sMWaterStepCnt = 0;
 409   3                  Pump_io = 0;
 410   3                  PunpFlag = 0;
 411   3                  sMWaterStep++;              
 412   3                }
 413   2              break;
 414   2              
 415   2              case 5://连续五分钟检测到水满，打开回流阀
 416   2                  
 417   2                  sMWaterStepCnt++;
 418   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 419   2                  {
 420   3                      sMWaterStepCnt = 0;
 421   3                      sMWaterStep++;    
 422   3                      
 423   3                  }
 424   2              break;
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 8   

 425   2                  
 426   2              case 6:
 427   2                  sMWaterStepCnt++;
 428   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 429   2                  {
 430   3                      sMWaterStepCnt = 0;
 431   3                      sMWaterStep++;    
 432   3                      HuiLiuFa_io = 0;
 433   3                      Pump_io = 0;
 434   3                  }
 435   2                  else
 436   2                  {
 437   3                      HuiLiuFa_io = 1;
 438   3                      Pump_io = 1;//打开回流阀
 439   3                  }
 440   2                  if(KeySwitchFlag )
 441   2                    HuiLiuFa_io = 0;
 442   2              break;
 443   2                  
 444   2              default:
 445   2              break;
 446   2              
 447   2              
 448   2            }
 449   1      }
 450          
 451          
 452          void JinShuiWorkProcess(void)
 453          {
 454   1          
 455   1      }
 456          
 457          /************************************************************************* 
 458          * 函数名称: sysRuning
 459          * 功能说明: 程序运行主体
 460          * 输    入: 无  
 461          * 输    出: 无
 462          *************************************************************************/
 463          void sysRuning(void)
 464          { 
 465   1      
 466   1        EventCollect();
 467   1          switch(PopEvent())
 468   1          {    
 469   2      
 470   2          case ev3MS:
 471   2             LED_sCan();
 472   2          break; 
 473   2              
 474   2              case ev5MS:       
 475   2                BuzzerProcess();
 476   2             //ADCollectProcess();  //  
 477   2              break;  
 478   2          
 479   2              case ev20MS:
 480   2              {
 481   3                  
 482   3              }       
 483   2              break;
 484   2              
 485   2              case ev50MS:
 486   2              {
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/23/2024 18:31:23 PAGE 9   

 487   3                  KeySelect();
*** WARNING C206 IN LINE 487 OF ..\Apps\sysRun.c: 'KeySelect': missing function-prototype
 488   3                  KeyRest();
*** WARNING C206 IN LINE 488 OF ..\Apps\sysRun.c: 'KeyRest': missing function-prototype
 489   3                  KeyGaoYaSwitch();
*** WARNING C206 IN LINE 489 OF ..\Apps\sysRun.c: 'KeyGaoYaSwitch': missing function-prototype
 490   3                  MakeWaterProcess();           
 491   3              }
 492   2              break;
 493   2              
 494   2              case ev100MS:
 495   2              {
 496   3                  LED_Process();  
 497   3                  TimeReminder();
 498   3                  ////EepromProcess();   
 499   3              }
 500   2              break;
 501   2              
 502   2              case ev1S:
 503   2              {
 504   3                  FilterSysRunTime();//滤芯寿命计算
 505   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 506   3              }
 507   2              break;
 508   2         
 509   2              default:
 510   2              break;
 511   2          }
 512   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2033    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     19    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
