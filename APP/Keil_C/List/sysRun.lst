C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(0,SIZE) BROWSE INTVECTOR(0X2800) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          
  16          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  17          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  18          
  19          
  20          void FactoryProcess(void)
  21          {
  22   1        static u8 sFactoryProcessCnt =0;
  23   1      
  24   1        if(FactoryModeFlag)
  25   1          FactoryModeFlag = 0;
  26   1      
  27   1        
  28   1      }
*** WARNING C280 IN LINE 22 OF ..\Apps\sysRun.c: 'sFactoryProcessCnt': unreferenced local variable
  29          
  30          /*****************************************************
  31          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
  32          *函数功能：模拟比较器初始化
  33          *入口参数：CMPIS=正端通道，CMPRF=负端电压
  34          *出口参数：void
  35          *****************************************************/
  36          void CMP_Init(void)
  37          {
  38   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
  39   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
  40   1          IE1 |= 0x20;
  41   1      }
  42          
  43          
  44          void sysRest(void)
  45          {
  46   1         memset(gbFlagData,0,10);
  47   1         memset(&gstFilte,0,sizeof(gstFilte));
  48   1         memset(&gstAM901,0,sizeof(gstAM901));
  49   1         memset(&gstRDsysTick,0,sizeof(gstRDsysTick));
  50   1         
  51   1         gstAM901.stFilter = &gstFilte;
  52   1      }
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 2   

  53          
  54          typedef enum
  55          {
  56            ROFilter,
  57            MixFilter
  58          }emFilter;
  59          
  60          
  61          
  62          
  63          /************************************************************************* 
  64          * 函数名称: FilterlifeTime
  65          * 功能说明: 用于计算滤芯寿命剩余时间
  66          * 输    入: 无  
  67          * 输    出: 无
  68          *************************************************************************/
  69          void FilterlifeTime(emFilter type)
  70          {
  71   1        if( type  == ROFilter)
  72   1        {
  73   2          
  74   2          gstFilte.RO_FlowRateCnt++;
  75   2        }
  76   1        else
  77   1        {
  78   2          gstFilte.Mix_FlowRate++;
  79   2        }
  80   1      
  81   1      }
  82          
  83          typedef union
  84          {
  85            u8  all;
  86            struct
  87            {
  88              u8 buzeerOn :1;
  89              u8 cnt    :7;
  90            }Bit;
  91          }ST_TimeReminder;
  92          
  93          void TimeReminder(void)
  94          {
  95   1        static ST_TimeReminder sTimeReminderCnt ={0};
  96   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
  97   1        
  98   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
  99   1          temp = gstAM901.Run.Bit.DayResidualPercent;
 100   1          
 101   1        if( gstFilte.type  == ROFilter)
 102   1        {
 103   2          if(temp <= 1)//寿命到期
 104   2          {
 105   3              LED2_R =1;
 106   3              LED2_L =0;
 107   3        #if 0     
                      if(KeySwitchFlag1)//制水时，检测到高压开关闭合
                      {
                        if(!sTimeReminderCnt.Bit.buzeerOn)
                        {
                          sTimeReminderCnt.Bit.buzeerOn = 1;
                          Buzzer1Flag = 1;
                        }
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 3   

                          
                      } 
              #endif        
 118   3          }
 119   2        
 120   2          else if(temp <=3)//寿命快到期
 121   2          {
 122   3          
 123   3      
 124   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1)
 125   3              {
 126   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 127   4                Buzzer4Flag = 1;
 128   4              }
 129   3              
 130   3              if(sTimeReminderCnt.Bit.cnt <= 5)
 131   3              {
 132   4                  LED2_R =1;
 133   4                  LED2_L =0;
 134   4                  Buzzer4Flag = 1;
 135   4              }
 136   3              else
 137   3              {
 138   4                  LED2_R =0;
 139   4                  LED2_L =0;
 140   4              }
 141   3              
 142   3              sTimeReminderCnt.Bit.cnt++;
 143   3              
 144   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 145   3                sTimeReminderCnt.Bit.cnt = 0;
 146   3              
 147   3          }
 148   2          else
 149   2          {
 150   3              LED2_R =0;
 151   3              LED2_L =1;
 152   3          }
 153   2        }
 154   1        else
 155   1        {
 156   2          if(temp <= 3)//寿命到期
 157   2          {
 158   3              LED1_R =1;
 159   3              LED1_L =0;
 160   3      
 161   3          }
 162   2        
 163   2          else if(temp <= 10)//寿命快到期
 164   2          {
 165   3              if(sTimeReminderCnt.Bit.cnt < 5)
 166   3              {
 167   4                  LED1_R =1;
 168   4                  LED1_L =0;
 169   4              }
 170   3              else
 171   3              {
 172   4                  LED1_R =0;
 173   4                  LED1_L =0;
 174   4              }
 175   3              
 176   3              sTimeReminderCnt.Bit.cnt++;
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 4   

 177   3              
 178   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 179   3                sTimeReminderCnt.Bit.cnt = 0;
 180   3          }
 181   2          else
 182   2          {
 183   3              LED1_R =0;
 184   3              LED1_L =1;
 185   3          }
 186   2        }
 187   1          
 188   1        
 189   1      }
 190          
 191          
 192          /************************************************************************* 
 193          * 函数名称: FilterSysRunTime
 194          * 功能说明: 用于滤芯寿命.单位秒
 195          * 输    入: 无  
 196          * 输    出: 无
 197          *************************************************************************/
 198          
 199          #define RO_DAY 1080ul
 200          #define MIX_3INI_DAY 360ul
 201          void FilterSysRunTime(void)
 202          {
 203   1         unsigned long  temp;
 204   1         float ftemp;
 205   1        if(gstFilte.type == ROFilter) 
 206   1        {
 207   2        /* 测试使用
 208   2          百分之2   90514640
 209   2          百分之3   0x5651D00
 210   2          百分之10  0x5017200
 211   2          
 212   2          */
 213   2          if(gstFilte.RO_DayCnt <0x058FD400 ) //3600*24*1080 0x01E13380
 214   2            gstFilte.RO_DayCnt++;
 215   2            
 216   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 217   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 218   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 219   2            
 220   2          if(temp < 108000ul)
 221   2          {
 222   3            temp = 108000ul-temp;
 223   3            ftemp = (float)temp/1080ul;
 224   3            gstAM901.Run.Bit.DayResidualPercent =  (u8)ftemp;
 225   3          }
 226   2          
 227   2          
 228   2        }
 229   1        else
 230   1        {
 231   2          /* 测试使用
 232   2          百分之3   0x01C9CE63
 233   2          百分之10   0x1AB2600
 234   2          百分之90  3110405
 235   2          */
 236   2          if(gstFilte.Mix_DayCnt <0x01DA9C00 )//3600*24*360 
 237   2            gstFilte.Mix_DayCnt++;
 238   2            
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 5   

 239   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 240   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 241   2          temp =  gstFilte.Mix_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 242   2          temp =  36000ul-temp; 
 243   2      
 244   2          ftemp = (float)temp/MIX_3INI_DAY;
 245   2          gstAM901.Run.Bit.DayResidualPercent = (u8)ftemp;
 246   2        }
 247   1      ///////////////////////////////////////////////////MIX_RO_DAY/////////////////////////////////////////////
             -//////////////
 248   1      
 249   1        
 250   1        if(gstFilte.type == ROFilter && PunpFlag) 
 251   1        {
 252   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 253   2            gstFilte.RO_FlowRateCnt++;
 254   2      
 255   2          /* 测试使用
 256   2          百分之1   90514640
 257   2          百分之3   0x5651D00
 258   2          百分之100  246388ul
 259   2          
 260   2          */  
 261   2            
 262   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 263   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 264   2          temp =  (float)gstFilte.RO_FlowRateCnt*0.04384;//2.63/60;//
 265   2          if(temp >10800ul )
 266   2            temp = 10800ul;
 267   2          
 268   2          temp =  10800-temp; 
 269   2      
 270   2          ftemp = (float)temp/108;
 271   2      
 272   2          gstAM901.Run.Bit.FlowResidualPercent = (u8)ftemp;
 273   2        }
 274   1        else if(gstFilte.type == MixFilter && PunpFlag)
 275   1        {
 276   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 277   2            gstFilte.Mix_FlowRate++;
 278   2            
 279   2          
 280   2      
 281   2            
 282   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 283   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 284   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 285   2          
 286   2          if(temp >3600ul )
 287   2            temp = 3600ul;
 288   2          
 289   2          temp =  3600-temp;  
 290   2      
 291   2          ftemp = ((float)temp)/36;
 292   2            
 293   2          gstAM901.Run.Bit.FlowResidualPercent =  (u8)ftemp;
 294   2        }
 295   1      }
 296          
 297          void LEDProcess(void)
 298          {
 299   1          if(!FirstPownOnFlag)
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 6   

 300   1          {
 301   2              return;
 302   2          } 
 303   1      }
 304          
 305          /************************************************************************* 
 306          * 函数名称: DevicePowerOn
 307          * 功能说明: 设备上电初始化
 308          * 输    入: 无  
 309          * 输    出: 无
 310          *************************************************************************/
 311          volatile  u8 sDPOCnt =0;nt =0;
 312          void DevicePowerOnInit(void)
 313          {
 314   1        
 315   1        Blueled_io = 1;
 316   1        Redled_io = 1;
 317   1        Chanel_IO1 = 1;
 318   1        Chanel_IO2 = 1;
 319   1        led1_io = 0;
 320   1        led2_io = 0;
 321   1        led3_io = 0;
 322   1        led4_io = 0;
 323   1        //Buzzer2Flag = 1;
 324   1        //BuzzerProcess();
 325   1        PWM_IndependentModeConfig(PWM02,2000);
 326   1        while(1)
 327   1        {
 328   2          if(Ev100MSFlag)
 329   2          {
 330   3            WDTCON |=0x10;
 331   3            sDPOCnt++;
 332   3            Ev100MSFlag =0;
 333   3            
 334   3              
 335   3              if(sDPOCnt>= 30)
 336   3            {
 337   4              break;
 338   4            }
 339   3            else if(sDPOCnt>= 2)
 340   3            {
 341   4              PWM_IndependentModeConfig(PWM02,0);
 342   4            }       
 343   3          }
 344   2        }
 345   1        Chanel_IO1 = 0;
 346   1        Chanel_IO2 = 0;
 347   1        led1_io = 0;
 348   1        led2_io = 0;
 349   1        led3_io = 0;
 350   1        led4_io = 0;
 351   1        Blueled_io = 0;
 352   1        Redled_io = 0;
 353   1      }
 354          
 355          /************************************************************************* 
 356          * 函数名称: FirstPowerOnProcess
 357          * 功能说明: 首次上电对设备清洗处理
 358          * 输    入: 无  
 359          * 输    出: 无
 360          *************************************************************************/
 361          void FirstPowerOnProcess(void)
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 7   

 362          {
 363   1          static u16 sTimeCnt = 0;
 364   1          if(!FirstPownOnFlag)
 365   1          {
 366   2              return;
 367   2          } 
 368   1          sTimeCnt++;
 369   1          JinShuiFa_io = 1;
 370   1          Pump_io = 1;
 371   1          FeiShuiFa_IO = 1;
 372   1          KongShuiFa_IO = 1;
 373   1          
 374   1          if(sTimeCnt > _15Min_Per1S)
 375   1          {
 376   2              JinShuiFa_io = 0;
 377   2              Pump_io = 0;
 378   2              FeiShuiFa_IO = 0;
 379   2              KongShuiFa_IO = 0;
 380   2              FirstPownOnFlag =  1;
 381   2          }
 382   1              
 383   1          
 384   1      }
 385          /************************************************************************* 
 386          * 函数名称: makeWaterProcess
 387          * 功能说明: 制作纯水
 388          * 输    入: 无  
 389          * 输    出: 无
 390          *************************************************************************/
 391          
 392          
 393          void MakeWaterProcess(void)
 394          {   
 395   1          static u8 sMWaterStep = 5;
 396   1          static u16 sMWaterStepCnt = 0;
 397   1        
 398   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 399   1          {
 400   2              return;
 401   2          } 
 402   1          
 403   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 404   1          {
 405   2            sMWaterStep =   0;
 406   2            MakeWaterFlag = 1;  
 407   2            HuiLiuFa_io = 0;
 408   2          }
 409   1      
 410   1          
 411   1        
 412   1          
 413   1          switch(sMWaterStep)
 414   1          {
 415   2              case 0:
 416   2                JinShuiFa_io =1;
 417   2                sMWaterStep =1;
 418   2                LED4_L =1;
 419   2                PunpFlag = 1;
 420   2                
 421   2              break;
 422   2              
 423   2              case 1://0.5秒后打开增压泵
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 8   

 424   2                sMWaterStepCnt++;
 425   2                if(sMWaterStepCnt > _500MS_Per50MS)
 426   2                {
 427   3                  sMWaterStepCnt = 0;
 428   3                  Pump_io = 1;
 429   3                  sMWaterStep++;
 430   3                }     
 431   2              break;
 432   2              
 433   2              case 2:
 434   2                if(!KeySwitchFlag)//水满
 435   2                {
 436   3                    sMWaterStep++;
 437   3                    LED4_L =0;
 438   3                }
 439   2              break;
 440   2              
 441   2              case 3:
 442   2                JinShuiFa_io = 0;//关闭进水阀
 443   2                sMWaterStepCnt = 0;
 444   2                sMWaterStep++;
 445   2                MakeWaterFlag = 0;
 446   2              break;
 447   2              
 448   2              case 4://0.5秒后关闭獗
 449   2                sMWaterStepCnt++;
 450   2                if(sMWaterStepCnt > _500MS_Per50MS)
 451   2                {
 452   3                  sMWaterStepCnt = 0;
 453   3                  Pump_io = 0;
 454   3                  PunpFlag = 0;
 455   3                  sMWaterStep++;              
 456   3                }
 457   2              break;
 458   2              
 459   2              case 5://连续五分钟检测到水满，打开回流阀
 460   2                  
 461   2                  sMWaterStepCnt++;
 462   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 463   2                  {
 464   3                      sMWaterStepCnt = 0;
 465   3                      sMWaterStep++;    
 466   3                      
 467   3                  }
 468   2              break;
 469   2                  
 470   2              case 6:
 471   2                  sMWaterStepCnt++;
 472   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 473   2                  {
 474   3                      sMWaterStepCnt = 0;
 475   3                      sMWaterStep++;    
 476   3                      HuiLiuFa_io = 0;
 477   3                      Pump_io = 0;
 478   3                  }
 479   2                  else
 480   2                  {
 481   3                      HuiLiuFa_io = 1;
 482   3                      Pump_io = 1;//打开回流阀
 483   3                  }
 484   2                  if(KeySwitchFlag )
 485   2                    HuiLiuFa_io = 0;
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 9   

 486   2              break;
 487   2                  
 488   2              default:
 489   2              break;
 490   2              
 491   2              
 492   2            }
 493   1      }
 494          
 495          
 496          void JinShuiWorkProcess(void)
 497          {
 498   1          
 499   1      }
 500          
 501          /************************************************************************* 
 502          * 函数名称: sysRuning
 503          * 功能说明: 程序运行主体
 504          * 输    入: 无  
 505          * 输    出: 无
 506          *************************************************************************/
 507          void sysRuning(void)
 508          { 
 509   1      
 510   1        EventCollect();
 511   1          switch(PopEvent())
 512   1          {    
 513   2      
 514   2          case ev3MS:
 515   2             LED_sCan();
 516   2          break; 
 517   2              
 518   2              case ev5MS:       
 519   2                BuzzerProcess();
 520   2             //ADCollectProcess();  //  
 521   2              break;  
 522   2          
 523   2              case ev20MS:
 524   2              {
 525   3                  
 526   3              }       
 527   2              break;
 528   2              
 529   2              case ev50MS:
 530   2              {
 531   3                  KeySelect();
*** WARNING C206 IN LINE 531 OF ..\Apps\sysRun.c: 'KeySelect': missing function-prototype
 532   3                  KeyRest();
*** WARNING C206 IN LINE 532 OF ..\Apps\sysRun.c: 'KeyRest': missing function-prototype
 533   3                  KeyGaoYaSwitch();
*** WARNING C206 IN LINE 533 OF ..\Apps\sysRun.c: 'KeyGaoYaSwitch': missing function-prototype
 534   3                  MakeWaterProcess();           
 535   3              }
 536   2              break;
 537   2              
 538   2              case ev100MS:
 539   2              {
 540   3                  LED_Process();  
 541   3                  TimeReminder();
 542   3                  TDS_Calulate();
*** WARNING C206 IN LINE 542 OF ..\Apps\sysRun.c: 'TDS_Calulate': missing function-prototype
 543   3                  ////EepromProcess();   
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/25/2024 20:30:54 PAGE 10  

 544   3              }
 545   2              break;
 546   2              
 547   2              case ev1S:
 548   2              {
 549   3                  FilterSysRunTime();//滤芯寿命计算
 550   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 551   3              }
 552   2              break;
 553   2         
 554   2              default:
 555   2              break;
 556   2          }
 557   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2243    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     20    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  5 WARNING(S),  0 ERROR(S)
