C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(0,SIZE) BROWSE INTVECTOR(0X1000) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          #include "..\Apps\includeall.h"
  16          
  17          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  18          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  19          
  20          
  21          #define STEP_1()  Pump_io =1;LED1_L=1;sFactoryStep++
  22          #define STEP_2()  JinShuiFa_io =1;LED2_L=1;sFactoryStep++
  23          #define STEP_3()  FeiShuiFa_IO =1;LED4_L=1;sFactoryStep++
  24          #define STEP_4()  HuiLiuFa_io =1;LED3_L=1;sFactoryStep++
  25          #define STEP_5()  KongShuiFa_IO =1;LED4_R=1;sFactoryStep++
  26          
  27          #define STEP_6()  BlueLedFlag =1;RedLedtFlag =1;gbFlagData[3].all =0XFF;Buzzer5Flag =1;sFactoryStep++
  28          #define STEP_7()  sFactoryStep++;
  29          extern void setLED(u8 num,emColor color ,U_LED state,u8 time);
  30          extern void test_TDS(u16 D, float *pp);
  31          
  32          void CloseFuZai(void)
  33          {
  34   1        JinShuiFa_io = 0;
  35   1        FeiShuiFa_IO = 0;
  36   1        HuiLiuFa_io = 0;
  37   1        KongShuiFa_IO = 0;
  38   1        Pump_io = 0;
  39   1      }
  40          
  41          void FactoryProcess(void)
  42          {
  43   1        static u16 FactoryPeriodCnt = 0;
  44   1          
  45   1        static u8 sFactoryStep =0;
  46   1      
  47   1        FactoryPeriodCnt++;
  48   1      
  49   1        if(!FactoryModeFlag)
  50   1        {
  51   2          
  52   2          return ;
  53   2        }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 2   

  54   1      
  55   1        if(FactoryModeFlag^HisFactoryModeFlag)
  56   1        {
  57   2          sFactoryStep =0;
  58   2          HisFactoryModeFlag = FactoryModeFlag;
  59   2          
  60   2          gbFlagData[3].all = 0;
  61   2          Buzzer5Flag = 0;
  62   2          RedLedtFlag = 0;
  63   2        }
  64   1      
  65   1        if(FactoryPeriodCnt%2 == 0)
  66   1        {
  67   2          switch(sFactoryStep)
  68   2          {
  69   3            case 0:
  70   3              STEP_1();
  71   3            break;
  72   3      
  73   3            case 1:
  74   3              STEP_2();
  75   3            break;
  76   3      
  77   3            case 2:
  78   3              STEP_3();
  79   3            break;
  80   3      
  81   3            case 3:
  82   3              STEP_4();
  83   3            break;
  84   3      
  85   3            case 4:
  86   3              STEP_5();
  87   3            break;
  88   3      
  89   3            case 5:
  90   3              STEP_6();
  91   3            break;
  92   3      
  93   3            case 6:
  94   3              STEP_7();
  95   3            break;
  96   3      
  97   3            case 7:
  98   3              gbFlagData[3].all = 0;
  99   3              BlueLedFlag = 0;
 100   3              RedLedtFlag = 0;
 101   3              CloseFuZai();
 102   3              sFactoryStep++;
 103   3            break;
 104   3      
 105   3            case 8:
 106   3               FstModeFlag = 1;
 107   3               FactoryModeFlag =0;
 108   3            break;
 109   3            
 110   3            
 111   3      
 112   3            default:
 113   3              break;
 114   3            
 115   3          }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 3   

 116   2        }
 117   1        
 118   1      }
 119          
 120          
 121          
 122          /*****************************************************
 123          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
 124          *函数功能：模拟比较器初始化
 125          *入口参数：CMPIS=正端通道，CMPRF=负端电压
 126          *出口参数：void
 127          *****************************************************/
 128          void CMP_Init(void)
 129          {
 130   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
 131   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
 132   1          IE1 |= 0x20;
 133   1      }
 134          
 135          
 136          void sysRest(void)
 137          {
 138   1         memset(gbFlagData,0,10);
 139   1         memset(&gstFilte,0,sizeof(gstFilte));
 140   1         memset(&gstAM901,0,sizeof(gstAM901));
 141   1         memset(&gstRDsysTick,0,sizeof(gstRDsysTick));
 142   1         gstAM901.stFilter = &gstFilte;
 143   1         FstModeFlag = 0;
 144   1         KeyCancelRestFlag = 0;
 145   1      }
 146          
 147          
 148          
 149          
 150          
 151          /************************************************************************* 
 152          * 函数名称: FilterlifeTime
 153          * 功能说明: 用于计算滤芯寿命剩余时间
 154          * 输    入: 无  
 155          * 输    出: 无
 156          *************************************************************************/
 157          void FilterlifeTime(void)
 158          {
 159   1        if(FstModeFlag)
 160   1        {
 161   2          if(gstFilte.type   == ROFilter)
 162   2          {     
 163   3            gstFilte.RO_FlowRateCnt+=600ul;
 164   3          }
 165   2          else
 166   2          {
 167   3            gstFilte.Mix_FlowRate+=600ul;
 168   3          }
 169   2        }
 170   1        else
 171   1        {
 172   2      
 173   2          if( gstFilte.type   == ROFilter)
 174   2          {
 175   3            
 176   3            gstFilte.RO_FlowRateCnt++;
 177   3          }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 4   

 178   2          else
 179   2          {
 180   3            gstFilte.Mix_FlowRate++;
 181   3          }
 182   2        }
 183   1        
 184   1      
 185   1      }
 186          
 187          void FilterlifeDayTime(void)
 188          {
 189   1        if(FstModeFlag)
 190   1        {
 191   2          if( gstFilte.type   == ROFilter)
 192   2          {
 193   3            gstFilte.RO_DayCnt+=86439ul;//86400ul-1
 194   3          }
 195   2          else
 196   2          {
 197   3            gstFilte.Mix_DayCnt+=86439ul;//86400ul-1
 198   3          }
 199   2        }
 200   1        else
 201   1        {
 202   2          if( gstFilte.type  == ROFilter)
 203   2          {
 204   3            
 205   3            gstFilte.RO_DayCnt++;
 206   3          }
 207   2          else
 208   2          {
 209   3            gstFilte.Mix_DayCnt++;
 210   3          }
 211   2        }
 212   1        
 213   1      
 214   1      }
 215          
 216          
 217          /************************************************************************* 
 218          * 函数名称: TimeReminder
 219          * 功能说明: 寿命到期处理
 220          * 输    入: 无  
 221          * 输    出: 无
 222          *************************************************************************/
 223          
 224          
 225          extern void CloseAllLED(void);
 226          void TimeReminder(void)
 227          {
 228   1        static ST_TimeReminder sTimeReminderCnt ={0};
 229   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
 230   1      
 231   1        if(FactoryModeFlag ||!SysRunFlag)
 232   1        {
 233   2          return ;
 234   2        }
 235   1       
 236   1        
 237   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
 238   1          temp = gstAM901.Run.Bit.DayResidualPercent;
 239   1        
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 5   

 240   1          
 241   1        if( gstFilte.type  == ROFilter)
 242   1        {
 243   2          if(temp <= 1)//寿命到期
 244   2          {
 245   3              if(!sTimeReminderCnt.Bit.buzeerOn1 && KeySwitchFlag1 /*&& ShuiLongTouOpen*/)
 246   3              {
 247   4                sTimeReminderCnt.Bit.buzeerOn = 0;
 248   4                sTimeReminderCnt.Bit.buzeerOn1 = 1;
 249   4                Buzzer1Flag = 1;
 250   4              }
 251   3              setLED(2,BlueColor,lightOff,0);
 252   3              setLED(2,RedColor,lightOn,0);
 253   3          }
 254   2        
 255   2          else if(temp <=3)//寿命快到期
 256   2          {
 257   3          
 258   3              
 259   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1/*&& ShuiLongTouOpen*/)
 260   3              {
 261   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 262   4                sTimeReminderCnt.Bit.buzeerOn1 = 0;
 263   4                Buzzer4Flag = 1;
 264   4                setLED(2,BlueColor,lightOff,0);
 265   4                setLED(2,RedColor,blink,_4S_Per100MS);
 266   4              }
 267   3              
 268   3              
 269   3              sTimeReminderCnt.Bit.cnt++;
 270   3              
 271   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 272   3                sTimeReminderCnt.Bit.cnt = 0;
 273   3              
 274   3          }
 275   2          else
 276   2          {
 277   3              setLED(2,RedColor,lightOff,0);
 278   3              setLED(1,BlueColor,lightOff,0);
 279   3              setLED(2,BlueColor,lightOn,0);  
 280   3          }
 281   2        }
 282   1        else
 283   1        {
 284   2          
 285   2          
 286   2          if(temp <= 3)//寿命到期
 287   2          {
 288   3              
 289   3              setLED(1,RedColor,lightOn,0);  
 290   3              if(!sTimeReminderCnt.Bit.buzeerOn1 && KeySwitchFlag1/*&& ShuiLongTouOpen*/)
 291   3              {
 292   4                sTimeReminderCnt.Bit.buzeerOn = 0;
 293   4                sTimeReminderCnt.Bit.buzeerOn1 = 1;
 294   4                Buzzer1Flag = 1;
 295   4              }
 296   3      
 297   3          }
 298   2        
 299   2          else if(temp <= 10)//寿命快到期
 300   2          {
 301   3      
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 6   

 302   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1/*&& ShuiLongTouOpen*/)
 303   3              {
 304   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 305   4                sTimeReminderCnt.Bit.buzeerOn1 = 0;
 306   4                Buzzer4Flag = 1;
 307   4                setLED(1,BlueColor,lightOff,0);
 308   4                setLED(1,RedColor,blink,_4S_Per100MS);
 309   4              }
 310   3              
 311   3              
 312   3              sTimeReminderCnt.Bit.cnt++;
 313   3              
 314   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 315   3                sTimeReminderCnt.Bit.cnt = 0;
 316   3          }
 317   2          else
 318   2          {
 319   3              setLED(2,BlueColor,lightOff,0);
 320   3              setLED(1,RedColor,lightOff,0);
 321   3              setLED(1,BlueColor,lightOn,0);
 322   3          }
 323   2        }
 324   1          
 325   1        
 326   1      }
 327          
 328          
 329          /************************************************************************* 
 330          * 函数名称: FilterSysRunTime
 331          * 功能说明: 用于滤芯寿命.单位秒
 332          * 输    入: 无  
 333          * 输    出: 无
 334          *************************************************************************/
 335          
 336          #define RO_DAY 1080ul
 337          #define MIX_3INI_DAY 360ul
 338          void FilterSysRunTime(void)
 339          {
 340   1         unsigned long  temp;
 341   1         float ftemp;
 342   1        if(gstFilte.type == ROFilter) 
 343   1        {
 344   2        /* 测试使用
 345   2          百分之2   90514640
 346   2          百分之3   0x5651D00
 347   2          百分之10  0x5017200
 348   2          
 349   2          */
 350   2          if(gstFilte.RO_DayCnt <0x058FD400 ) //3600*24*1080 0x01E13380
 351   2            FilterlifeDayTime();
 352   2            
 353   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 354   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 355   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 356   2            
 357   2          if(temp < 108000ul)
 358   2          {
 359   3            temp = 108000ul-temp;
 360   3            ftemp = (float)temp/1080ul;
 361   3            gstAM901.Run.Bit.DayResidualPercent =  (u8)ftemp;
 362   3          }
 363   2          
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 7   

 364   2          
 365   2        }
 366   1        else
 367   1        {
 368   2          /* 测试使用
 369   2          百分之3   0x01C9CE63
 370   2          百分之10   0x1AB2600
 371   2          百分之90  3110405
 372   2          */
 373   2          if(gstFilte.Mix_DayCnt <0x01DA9C00 )//3600*24*360 
 374   2            FilterlifeDayTime();
 375   2            
 376   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 377   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 378   2          temp =  gstFilte.Mix_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 379   2          temp =  36000ul-temp; 
 380   2      
 381   2          ftemp = (float)temp/MIX_3INI_DAY;
 382   2          gstAM901.Run.Bit.DayResidualPercent = (u8)ftemp;
 383   2        }
 384   1      ///////////////////////////////////////////////////MIX_RO_DAY/////////////////////////////////////////////
             -//////////////
 385   1      
 386   1        
 387   1        if(gstFilte.type == ROFilter && PunpFlag) 
 388   1        {
 389   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 390   2            FilterlifeTime();
 391   2      
 392   2          /* 测试使用
 393   2          百分之1   90514640
 394   2          百分之3   0x5651D00
 395   2          百分之100  246388ul
 396   2          
 397   2          */  
 398   2            
 399   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 400   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 401   2          temp =  (float)gstFilte.RO_FlowRateCnt*0.04384;//2.63/60;//
 402   2          if(temp >10800ul )
 403   2            temp = 10800ul;
 404   2          
 405   2          temp =  10800-temp; 
 406   2      
 407   2          ftemp = (float)temp/108;
 408   2      
 409   2          gstAM901.Run.Bit.FlowResidualPercent = (u8)ftemp;
 410   2        }
 411   1        else if(gstFilte.type == MixFilter && PunpFlag)
 412   1        {
 413   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 414   2            FilterlifeTime();;
 415   2            
 416   2          
 417   2      
 418   2            
 419   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 420   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 421   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 422   2          
 423   2          if(temp >3600ul )
 424   2            temp = 3600ul;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 8   

 425   2          
 426   2          temp =  3600-temp;  
 427   2      
 428   2          ftemp = ((float)temp)/36;
 429   2            
 430   2          gstAM901.Run.Bit.FlowResidualPercent =  (u8)ftemp;
 431   2        }
 432   1      }
 433          
 434           
 435          
 436          /************************************************************************* 
 437          * 函数名称: DevicePowerOn
 438          * 功能说明: 设备上电初始化
 439          * 输    入: 无  
 440          * 输    出: 无
 441          *************************************************************************/
 442          volatile  u8 sDPOCnt =0;nt =0;
 443          void DevicePowerOnInit(void)
 444          {
 445   1        
 446   1        Blueled_io = 1;
 447   1        Redled_io = 1;
 448   1        Chanel_IO1 = 1;
 449   1        Chanel_IO2 = 1;
 450   1        led1_io = 0;
 451   1        led2_io = 0;
 452   1        led3_io = 0;
 453   1        led4_io = 0;
 454   1        //Buzzer2Flag = 1;
 455   1        //BuzzerProcess();
 456   1        PWM_IndependentModeConfig(PWM02,2000);
 457   1        while(1)
 458   1        {
 459   2          if(Ev100MSFlag)
 460   2          {
 461   3            WDTCON |=0x10;
 462   3            sDPOCnt++;
 463   3            Ev100MSFlag =0;
 464   3            
 465   3              
 466   3             if(sDPOCnt>= 30)
 467   3            {
 468   4              break;
 469   4            }
 470   3            else if(sDPOCnt>= 2)
 471   3            {
 472   4              PWM_IndependentModeConfig(PWM02,0);
 473   4            }       
 474   3          }
 475   2        }
 476   1        Chanel_IO1 = 0;
 477   1        Chanel_IO2 = 0;
 478   1        Blueled_io = 0;
 479   1        Redled_io = 0;
 480   1      }
 481          
 482          /************************************************************************* 
 483          * 函数名称: FirstPowerOnProcess
 484          * 功能说明: 首次上电对设备清洗处理
 485          * 输    入: 无  
 486          * 输    出: 无
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 9   

 487          *************************************************************************/
 488          void FirstPowerOnProcess(void)
 489          {
 490   1          static u16 sTimeCnt = 0;
 491   1          if(!FirstPownOnFlag)
 492   1          {
 493   2              return;
 494   2          } 
 495   1          sTimeCnt++;
 496   1          JinShuiFa_io = 1;
 497   1          Pump_io = 1;
 498   1          FeiShuiFa_IO = 1;
 499   1          KongShuiFa_IO = 1;
 500   1          
 501   1          if(sTimeCnt > _15Min_Per1S)
 502   1          {
 503   2              JinShuiFa_io = 0;
 504   2              Pump_io = 0;
 505   2              FeiShuiFa_IO = 0;
 506   2              KongShuiFa_IO = 0;
 507   2              FirstPownOnFlag =  1;
 508   2          }
 509   1              
 510   1          
 511   1      }
 512          /************************************************************************* 
 513          * 函数名称: RestFilter
 514          * 功能说明: 复位滤芯
 515          * 输    入: 无  
 516          * 输    出: 无
 517          *************************************************************************/
 518          void RestFilter(void)
 519          {
 520   1          WriteTempEeprom(0);
 521   1          if(gstFilte.type == ROFilter)
 522   1          {     
 523   2                gstFilte.RO_DayCnt =0;
 524   2                gstFilte.RO_FlowRateCnt = 0;
 525   2                setLED(2,BlueColor,lightOff,0);
 526   2                setLED(2,BlueColor,blink,_4S_Per100MS);
 527   2          }
 528   1          else
 529   1          {
 530   2                gstFilte.Mix_DayCnt =0;
 531   2                gstFilte.Mix_FlowRate = 0;  
 532   2                setLED(1,BlueColor,lightOff,0);
 533   2                setLED(1,BlueColor,blink,_4S_Per100MS);
 534   2          }
 535   1      }
 536          
 537          
 538          /************************************************************************* 
 539          * 函数名称: PaiShuiProcess
 540          * 功能说明: 制作纯水
 541          * 输    入: 无  
 542          * 输    出: 无
 543          *************************************************************************/
 544          
 545          
 546          void PaiShuiProcess(void)//1S钟运行一次
 547          {
 548   1        static u8 sTDS_Time =0;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 10  

 549   1        
 550   1        test_TDS(gstADCollect.fChunShui,&gstADCollect.tds_ChunShui);
 551   1        test_TDS(gstADCollect.fYuanShui,&gstADCollect.tds_YuanShui);//检测10次求平均值
 552   1        test_TDS(gstADCollect.fJieShui,&gstADCollect.tds_JieShui);//检测10次求平均值
 553   1        test_TDS(gstADCollect.fLouShui,&gstADCollect.tds_LouShui);//检测10次求平均值
 554   1        TDS_ChunShuiFalg = 1;
 555   1        if(sTDS_Time < 60)
 556   1        {
 557   2            TDS_YuanShuiFalg =1;
 558   2            
 559   2            if(gstADCollect.tds_YuanShui <= TDS_100)
 560   2            { 
 561   3              gstAM901.PaiShuiDaoJiShi = _9Min_Per1S;
 562   3            }
 563   2      
 564   2            else if(gstADCollect.tds_YuanShui <= TDS_300)
 565   2            {
 566   3              gstAM901.PaiShuiDaoJiShi = _8Min_Per1S;//KongShuiFa_IO = 1; 
 567   3            }
 568   2      
 569   2            else if(gstADCollect.tds_YuanShui <= TDS_500)
 570   2            {
 571   3              gstAM901.PaiShuiDaoJiShi = _4Min_Per1S;//KongShuiFa_IO = 1; 
 572   3            }
 573   2            else//上店10秒内TTDS <100
 574   2            {
 575   3              gstAM901.PaiShuiDaoJiShi  =0;//KongShuiFa_IO = 1; 
 576   3            }
 577   2        }
 578   1        if(gstADCollect.tds_JieShui > TDS_1000)
 579   1        {
 580   2            gstAM901.PaiShuiDaoJiShi = 1;
 581   2        }
 582   1      
 583   1        if(sTDS_Time < 60)
 584   1        {
 585   2          sTDS_Time++;
 586   2        }   
 587   1        else
 588   1        {
 589   2          if(gstAM901.PaiShuiDaoJiShi > 0 && (gstAM901.PaiShuiDaoJiShi !=0xffff))
 590   2          {
 591   3            gstAM901.PaiShuiDaoJiShi--;
 592   3          }
 593   2          
 594   2          else
 595   2          {
 596   3            KongShuiFa_IO = 1;
 597   3            gstAM901.PaiShuiDaoJiShi =0xffff;
 598   3          }
 599   2          
 600   2          
 601   2          if(!KeySwitchFlag)//水满
 602   2          {
 603   3              KongShuiFa_IO = 0;
 604   3          }
 605   2        }
 606   1        
 607   1      
 608   1      }
 609          
 610          
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 11  

 611          
 612          void MakeWaterProcess(void)
 613          {   
 614   1          static u8 sMWaterStep = 5;
 615   1          static u16 sMWaterStepCnt = 0;
 616   1      
 617   1          if(ErrowFlag||FactoryModeFlag || !SysRunFlag)
 618   1          {
 619   2            return ;
 620   2          }
 621   1        
 622   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 623   1          {
 624   2              return;
 625   2          } 
 626   1          
 627   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 628   1          {
 629   2            sMWaterStep =   0;
 630   2            MakeWaterFlag = 1;  
 631   2            HuiLiuFa_io = 0;
 632   2          }
 633   1      
 634   1          
 635   1        
 636   1          
 637   1          switch(sMWaterStep)
 638   1          {
 639   2              case 0:
 640   2                JinShuiFa_io =1;
 641   2                sMWaterStep =1;
 642   2                LED4_L =1;
 643   2                PunpFlag = 1;
 644   2                
 645   2              break;
 646   2              
 647   2              case 1://0.5秒后打开增压泵
 648   2                sMWaterStepCnt++;
 649   2                if(sMWaterStepCnt > _500MS_Per50MS)
 650   2                {
 651   3                  sMWaterStepCnt = 0;
 652   3                  Pump_io = 1;
 653   3                  sMWaterStep++;
 654   3                  ChuShuiFlag = 1;
 655   3                  
 656   3                }     
 657   2              break;
 658   2              
 659   2              case 2:
 660   2              
 661   2                if(!KeySwitchFlag)//水满
 662   2                {
 663   3                    if(!ErrowFlag)
 664   3                    {
 665   4                        gstAM901.LianXuZhiShuiCnt =0;
 666   4                    }             
 667   3                    sMWaterStep++;
 668   3                    LED4_L =0;
 669   3                }
 670   2      
 671   2                if(_20Min_Per50MS < gstAM901.LianXuZhiShuiCnt++)
 672   2                {
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 12  

 673   3                  ChuShuiFlag = 0;
 674   3                  ErrowFlag =  1;
 675   3                  CloseFuZai();
 676   3                  setLED(3,RedColor ,blink,_4S_Per100MS);
 677   3                }
 678   2              break;
 679   2              
 680   2              case 3:
 681   2                JinShuiFa_io = 0;//关闭进水阀
 682   2                sMWaterStepCnt = 0;
 683   2                sMWaterStep++;
 684   2                MakeWaterFlag = 0;
 685   2              break;
 686   2              
 687   2              case 4://0.5秒后关闭獗
 688   2                sMWaterStepCnt++;
 689   2                
 690   2                if(sMWaterStepCnt > _500MS_Per50MS)
 691   2                {
 692   3                  sMWaterStepCnt = 0;
 693   3                  Pump_io = 0;
 694   3                  PunpFlag = 0;
 695   3                  sMWaterStep++;      
 696   3                  ChuShuiFlag = 0;
 697   3                }
 698   2              break;
 699   2              
 700   2              case 5://连续五分钟检测到水满，打开回流阀
 701   2                  
 702   2                  sMWaterStepCnt++;
 703   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 704   2                  {
 705   3                      sMWaterStepCnt = 0;
 706   3                      sMWaterStep++;    
 707   3                      
 708   3                  }
 709   2              break;
 710   2                  
 711   2              case 6:
 712   2                  sMWaterStepCnt++;
 713   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 714   2                  {
 715   3                      sMWaterStepCnt = 0;
 716   3                      sMWaterStep++;    
 717   3                      HuiLiuFa_io = 0;
 718   3                      Pump_io = 0;
 719   3                  }
 720   2                  else
 721   2                  {
 722   3                      HuiLiuFa_io = 1;
 723   3                      Pump_io = 1;//打开回流阀
 724   3                  }
 725   2                  if(KeySwitchFlag )
 726   2                    HuiLiuFa_io = 0;
 727   2              break;
 728   2                  
 729   2              default:
 730   2              break;
 731   2              
 732   2              
 733   2            }
 734   1      }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 13  

 735          
 736          // TDS值校准
 737          
 738          void TDS_JiaoZhun(u16 v0,u16 AdValue_0,u16 v1,u16 AdValue_1)
 739          {
 740   1        float a,b;
 741   1      
 742   1        
 743   1          if(v0 > v1)
 744   1          {
 745   2              a= (v0- v1);
 746   2              a= a*4095/(float)(AdValue_0-AdValue_1);
 747   2              b = AdValue_1/(float)4095;
 748   2              b = b*a;
 749   2              b =  v1- b;
 750   2          }
 751   1          else
 752   1          {
 753   2              a= (v1- v0);
 754   2              a= a*4095/(float)(AdValue_1-AdValue_0);
 755   2              b = AdValue_1/(float)4095;
 756   2              b = b*a;
 757   2              b =  v1- b;
 758   2              b= 0;
 759   2          }
 760   1        
 761   1      }
 762          
 763          void PowerDownProcess(void)
 764          {
 765   1              EA =0;
 766   1              GPIO_Init(GPIO0, GPIO_PIN_2,GPIO_MODE_IN_HI);
 767   1              GPIO_Init(GPIO0, GPIO_PIN_4,GPIO_MODE_IN_HI);
 768   1              GPIO_Init(GPIO4, GPIO_PIN_3,GPIO_MODE_IN_HI);
 769   1              GPIO_Init(GPIO4, GPIO_PIN_2,GPIO_MODE_IN_HI);
 770   1              GPIO_Init(GPIO4, GPIO_PIN_1,GPIO_MODE_IN_HI);
 771   1              GPIO_Init(GPIO3, GPIO_PIN_7,GPIO_MODE_IN_HI);
 772   1              GPIO_Init(GPIO3, GPIO_PIN_5,GPIO_MODE_IN_HI);
 773   1              GPIO_Init(GPIO3, GPIO_PIN_4,GPIO_MODE_IN_HI);
 774   1              GPIO_Init(GPIO3, GPIO_PIN_3,GPIO_MODE_IN_HI);
 775   1              GPIO_Init(GPIO3, GPIO_PIN_2,GPIO_MODE_IN_HI);
 776   1              GPIO_Init(GPIO3, GPIO_PIN_1,GPIO_MODE_IN_HI);
 777   1              GPIO_Init(GPIO1, GPIO_PIN_0,GPIO_MODE_IN_HI);
 778   1              GPIO_Init(GPIO1, GPIO_PIN_2,GPIO_MODE_IN_HI);
 779   1              GPIO_Init(GPIO1, GPIO_PIN_4,GPIO_MODE_IN_HI);
 780   1              GPIO_Init(GPIO2, GPIO_PIN_5,GPIO_MODE_IN_HI);
 781   1              GPIO_Init(GPIO2, GPIO_PIN_6,GPIO_MODE_IN_HI);
 782   1              GPIO_Init(GPIO2, GPIO_PIN_7,GPIO_MODE_IN_HI);
 783   1              GPIO_Init(GPIO0, GPIO_PIN_0,GPIO_MODE_IN_HI);
 784   1              GPIO_Init(GPIO0, GPIO_PIN_1,GPIO_MODE_IN_HI);        
 785   1              WriteTempEeprom(1);
 786   1              EA =1;      
 787   1      }
 788          
 789          
 790          /************************************************************************* 
 791          * 函数名称: sysRuning
 792          * 功能说明: 程序运行主体
 793          * 输    入: 无  
 794          * 输    出: 无
 795          *************************************************************************/
 796          extern void TDS_Calulate(void);
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 14  

 797          extern  void KeyGaoYaSwitch(void);
 798          extern void KeyRest(void);
 799          extern void KeySelect(void);
 800          extern void NoKeyProcess(void);
 801          u16 gPPM1 = 110 ,gPPM2 = 50 ,gAD1 = 1420 ,gAD2 =1120;
 802          
 803          void sysRuning(void)
 804          { 
 805   1      
 806   1        EventCollect();
 807   1          switch(PopEvent())
 808   1          {    
 809   2            case evPowerDown:
 810   2            {
 811   3                PowerDownProcess();
 812   3            }       
 813   2            break;
 814   2            
 815   2              case ev5MS:       
 816   2                BuzzerProcess();  
 817   2                
 818   2              break;  
 819   2      
 820   2              
 821   2              case ev50MS:
 822   2              {
 823   3                  KeySelect();
 824   3                  KeyRest();
 825   3                  KeyCancelRestKey();
 826   3                  NoKeyProcess();
 827   3                  KeyGaoYaSwitch();
 828   3                  MakeWaterProcess();       
 829   3              }
 830   2              break;
 831   2              
 832   2              case ev100MS:
 833   2              {
 834   3                  
 835   3                  TimeReminder();
 836   3                  TDS_Calulate();
 837   3                  UART0_SendData(); 
 838   3                  LED_Process();  
 839   3              }
 840   2              break;
 841   2              
 842   2              case ev1S:
 843   2              {
 844   3                  TDS_JiaoZhun(gPPM1,gAD1,gPPM2,gAD2);
 845   3                  FilterSysRunTime();//滤芯寿命计算
 846   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 847   3                  FactoryProcess();
 848   3                  SysRunFlag =1;
 849   3                  PaiShuiProcess();
 850   3              }
 851   2              break;
 852   2         
 853   2              default:
 854   2              break;
 855   2          }
 856   1      }


C51 COMPILER V9.59.0.0   SYSRUN                                                            04/08/2024 14:55:08 PAGE 15  

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4217    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     46    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
