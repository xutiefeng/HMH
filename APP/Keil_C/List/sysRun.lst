C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(0,SIZE) BROWSE INTVECTOR(0X1000) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          
  16          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  17          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  18          
  19          
  20          #define STEP_1()  Pump_io =1;LED1_L=1;sFactoryStep++
  21          #define STEP_2()  JinShuiFa_io =1;LED2_L=1;sFactoryStep++
  22          #define STEP_3()  FeiShuiFa_IO =1;LED4_L=1;sFactoryStep++
  23          #define STEP_4()  HuiLiuFa_io =1;LED3_L=1;sFactoryStep++
  24          #define STEP_5()  KongShuiFa_IO =1;LED4_R=1;sFactoryStep++
  25          
  26          #define STEP_6()  BlueLedFlag =1;RedLedtFlag =1;gbFlagData[3].all =0XFF;Buzzer5Flag =1;sFactoryStep++
  27          #define STEP_7()  sFactoryStep++;
  28          extern void setLED(u8 num,emColor color ,U_LED state,u8 time);
  29          extern void test_TDS(u16 D, float *pp);
  30          
  31          void CloseFuZai(void)
  32          {
  33   1        JinShuiFa_io = 0;
  34   1        FeiShuiFa_IO = 0;
  35   1        HuiLiuFa_io = 0;
  36   1        KongShuiFa_IO = 0;
  37   1        Pump_io = 0;
  38   1      }
  39          
  40          void FactoryProcess(void)
  41          {
  42   1        static u16 FactoryPeriodCnt = 0;
  43   1          
  44   1        static u8 sFactoryStep =0;
  45   1      
  46   1        FactoryPeriodCnt++;
  47   1      
  48   1        if(!FactoryModeFlag)
  49   1        {
  50   2          
  51   2          return ;
  52   2        }
  53   1      
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 2   

  54   1        if(FactoryModeFlag^HisFactoryModeFlag)
  55   1        {
  56   2          sFactoryStep =0;
  57   2          HisFactoryModeFlag = FactoryModeFlag;
  58   2          
  59   2          gbFlagData[3].all = 0;
  60   2          Buzzer5Flag = 0;
  61   2          RedLedtFlag = 0;
  62   2        }
  63   1      
  64   1        if(FactoryPeriodCnt%2 == 0)
  65   1        {
  66   2          switch(sFactoryStep)
  67   2          {
  68   3            case 0:
  69   3              STEP_1();
  70   3            break;
  71   3      
  72   3            case 1:
  73   3              STEP_2();
  74   3            break;
  75   3      
  76   3            case 2:
  77   3              STEP_3();
  78   3            break;
  79   3      
  80   3            case 3:
  81   3              STEP_4();
  82   3            break;
  83   3      
  84   3            case 4:
  85   3              STEP_5();
  86   3            break;
  87   3      
  88   3            case 5:
  89   3              STEP_6();
  90   3            break;
  91   3      
  92   3            case 6:
  93   3              STEP_7();
  94   3            break;
  95   3      
  96   3            case 7:
  97   3              gbFlagData[3].all = 0;
  98   3              BlueLedFlag = 0;
  99   3              RedLedtFlag = 0;
 100   3              CloseFuZai();
 101   3              sFactoryStep++;
 102   3            break;
 103   3      
 104   3            case 8:
 105   3               FstModeFlag = 1;
 106   3               FactoryModeFlag =0;
 107   3            break;
 108   3            
 109   3            
 110   3      
 111   3            default:
 112   3              break;
 113   3            
 114   3          }
 115   2        }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 3   

 116   1        
 117   1      }
 118          
 119          
 120          
 121          /*****************************************************
 122          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
 123          *函数功能：模拟比较器初始化
 124          *入口参数：CMPIS=正端通道，CMPRF=负端电压
 125          *出口参数：void
 126          *****************************************************/
 127          void CMP_Init(void)
 128          {
 129   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
 130   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
 131   1          IE1 |= 0x20;
 132   1      }
 133          
 134          
 135          void sysRest(void)
 136          {
 137   1         memset(gbFlagData,0,10);
 138   1         memset(&gstFilte,0,sizeof(gstFilte));
 139   1         memset(&gstAM901,0,sizeof(gstAM901));
 140   1         memset(&gstRDsysTick,0,sizeof(gstRDsysTick));
 141   1         gstAM901.stFilter = &gstFilte;
 142   1      }
 143          
 144          
 145          
 146          
 147          
 148          /************************************************************************* 
 149          * 函数名称: FilterlifeTime
 150          * 功能说明: 用于计算滤芯寿命剩余时间
 151          * 输    入: 无  
 152          * 输    出: 无
 153          *************************************************************************/
 154          void FilterlifeTime(emFilter type)
 155          {
 156   1        if(FstModeFlag)
 157   1        {
 158   2          if( type  == ROFilter)
 159   2          {     
 160   3            gstFilte.RO_FlowRateCnt+=600ul;
 161   3          }
 162   2          else
 163   2          {
 164   3            gstFilte.Mix_FlowRate+=600ul;
 165   3          }
 166   2        }
 167   1        else
 168   1        {
 169   2      
 170   2          if( type  == ROFilter)
 171   2          {
 172   3            
 173   3            gstFilte.RO_FlowRateCnt++;
 174   3          }
 175   2          else
 176   2          {
 177   3            gstFilte.Mix_FlowRate++;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 4   

 178   3          }
 179   2        }
 180   1        
 181   1      
 182   1      }
 183          
 184          void FilterlifeDayTime(emFilter type)
 185          {
 186   1        if(FstModeFlag)
 187   1        {
 188   2          if( type  == ROFilter)
 189   2          {
 190   3            gstFilte.RO_DayCnt+=86400ul;
 191   3          }
 192   2          else
 193   2          {
 194   3            gstFilte.Mix_DayCnt+=86400ul;
 195   3          }
 196   2        }
 197   1        else
 198   1        {
 199   2          if( type  == ROFilter)
 200   2          {
 201   3            
 202   3            gstFilte.RO_DayCnt++;
 203   3          }
 204   2          else
 205   2          {
 206   3            gstFilte.Mix_DayCnt++;
 207   3          }
 208   2        }
 209   1        
 210   1      
 211   1      }
 212          
 213          
 214          /************************************************************************* 
 215          * 函数名称: TimeReminder
 216          * 功能说明: 寿命到期处理
 217          * 输    入: 无  
 218          * 输    出: 无
 219          *************************************************************************/
 220          
 221          
 222          
 223          void TimeReminder(void)
 224          {
 225   1        static ST_TimeReminder sTimeReminderCnt ={0};
 226   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
 227   1      
 228   1        if(FactoryModeFlag ||!SysRunFlag)
 229   1        {
 230   2          return ;
 231   2        }
 232   1       
 233   1        
 234   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
 235   1          temp = gstAM901.Run.Bit.DayResidualPercent;
 236   1        
 237   1          
 238   1        if( gstFilte.type  == ROFilter)
 239   1        {
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 5   

 240   2          LED1_R =0;
 241   2          LED1_L =0;
 242   2          if(temp <= 1)//寿命到期
 243   2          {
 244   3              if(!sTimeReminderCnt.Bit.buzeerOn1 && KeySwitchFlag1 && ShuiLongTouOpen)
 245   3              {
 246   4                sTimeReminderCnt.Bit.buzeerOn = 0;
 247   4                sTimeReminderCnt.Bit.buzeerOn1 = 1;
 248   4                Buzzer1Flag = 1;
 249   4              }
 250   3              LED2_R =1;
 251   3              LED2_L =0;  
 252   3          }
 253   2        
 254   2          else if(temp <=3)//寿命快到期
 255   2          {
 256   3          
 257   3      
 258   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1&& ShuiLongTouOpen)
 259   3              {
 260   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 261   4                sTimeReminderCnt.Bit.buzeerOn1 = 0;
 262   4                Buzzer4Flag = 1;
 263   4              }
 264   3              
 265   3              if(sTimeReminderCnt.Bit.cnt <= 5)
 266   3              {
 267   4                  LED2_R =1;
 268   4                  LED2_L =0;
 269   4              }
 270   3              else
 271   3              {
 272   4                  LED2_R =0;
 273   4                  LED2_L =0;
 274   4              }
 275   3              
 276   3              sTimeReminderCnt.Bit.cnt++;
 277   3              
 278   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 279   3                sTimeReminderCnt.Bit.cnt = 0;
 280   3              
 281   3          }
 282   2          else
 283   2          {
 284   3              setLED(2,BlueColor,lightOn,0);      
 285   3          }
 286   2        }
 287   1        else
 288   1        {
 289   2          
 290   2          LED2_R =0;
 291   2          LED2_L =0;
 292   2          if(temp <= 3)//寿命到期
 293   2          {
 294   3              LED1_R =1;
 295   3              LED1_L =0;
 296   3                
 297   3              if(!sTimeReminderCnt.Bit.buzeerOn1 && KeySwitchFlag1&& ShuiLongTouOpen)
 298   3              {
 299   4                sTimeReminderCnt.Bit.buzeerOn = 0;
 300   4                sTimeReminderCnt.Bit.buzeerOn1 = 1;
 301   4                Buzzer1Flag = 1;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 6   

 302   4              }
 303   3      
 304   3          }
 305   2        
 306   2          else if(temp <= 10)//寿命快到期
 307   2          {
 308   3      
 309   3              if(!sTimeReminderCnt.Bit.buzeerOn && KeySwitchFlag1&& ShuiLongTouOpen)
 310   3              {
 311   4                sTimeReminderCnt.Bit.buzeerOn = 1;
 312   4                sTimeReminderCnt.Bit.buzeerOn1 = 0;
 313   4                Buzzer4Flag = 1;
 314   4              }
 315   3              
 316   3              if(sTimeReminderCnt.Bit.cnt < 5)
 317   3              {
 318   4                  LED1_R =1;
 319   4                  LED1_L =0;
 320   4              }
 321   3              else
 322   3              {
 323   4                  LED1_R =0;
 324   4                  LED1_L =0;
 325   4              }
 326   3              
 327   3              sTimeReminderCnt.Bit.cnt++;
 328   3              
 329   3              if(sTimeReminderCnt.Bit.cnt >= 10)
 330   3                sTimeReminderCnt.Bit.cnt = 0;
 331   3          }
 332   2          else
 333   2          {
 334   3              //LED1_R =0;
 335   3              //LED1_L =1;
 336   3              setLED(1,BlueColor,lightOn,0);
 337   3          }
 338   2        }
 339   1          
 340   1        
 341   1      }
 342          
 343          
 344          /************************************************************************* 
 345          * 函数名称: FilterSysRunTime
 346          * 功能说明: 用于滤芯寿命.单位秒
 347          * 输    入: 无  
 348          * 输    出: 无
 349          *************************************************************************/
 350          
 351          #define RO_DAY 1080ul
 352          #define MIX_3INI_DAY 360ul
 353          void FilterSysRunTime(void)
 354          {
 355   1         unsigned long  temp;
 356   1         float ftemp;
 357   1        if(gstFilte.type == ROFilter) 
 358   1        {
 359   2        /* 测试使用
 360   2          百分之2   90514640
 361   2          百分之3   0x5651D00
 362   2          百分之10  0x5017200
 363   2          
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 7   

 364   2          */
 365   2          if(gstFilte.RO_DayCnt <0x058FD400 ) //3600*24*1080 0x01E13380
 366   2            FilterlifeDayTime();
*** WARNING C209 IN LINE 366 OF ..\Apps\sysRun.c: '_FilterlifeDayTime': too few actual parameters
 367   2            
 368   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 369   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 370   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 371   2            
 372   2          if(temp < 108000ul)
 373   2          {
 374   3            temp = 108000ul-temp;
 375   3            ftemp = (float)temp/1080ul;
 376   3            gstAM901.Run.Bit.DayResidualPercent =  (u8)ftemp;
 377   3          }
 378   2          
 379   2          
 380   2        }
 381   1        else
 382   1        {
 383   2          /* 测试使用
 384   2          百分之3   0x01C9CE63
 385   2          百分之10   0x1AB2600
 386   2          百分之90  3110405
 387   2          */
 388   2          if(gstFilte.Mix_DayCnt <0x01DA9C00 )//3600*24*360 
 389   2            FilterlifeDayTime();
*** WARNING C209 IN LINE 389 OF ..\Apps\sysRun.c: '_FilterlifeDayTime': too few actual parameters
 390   2            
 391   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 392   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 393   2          temp =  gstFilte.Mix_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 394   2          temp =  36000ul-temp; 
 395   2      
 396   2          ftemp = (float)temp/MIX_3INI_DAY;
 397   2          gstAM901.Run.Bit.DayResidualPercent = (u8)ftemp;
 398   2        }
 399   1      ///////////////////////////////////////////////////MIX_RO_DAY/////////////////////////////////////////////
             -//////////////
 400   1      
 401   1        
 402   1        if(gstFilte.type == ROFilter && PunpFlag) 
 403   1        {
 404   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 405   2            FilterlifeTime();
*** WARNING C209 IN LINE 405 OF ..\Apps\sysRun.c: '_FilterlifeTime': too few actual parameters
 406   2      
 407   2          /* 测试使用
 408   2          百分之1   90514640
 409   2          百分之3   0x5651D00
 410   2          百分之100  246388ul
 411   2          
 412   2          */  
 413   2            
 414   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 415   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 416   2          temp =  (float)gstFilte.RO_FlowRateCnt*0.04384;//2.63/60;//
 417   2          if(temp >10800ul )
 418   2            temp = 10800ul;
 419   2          
 420   2          temp =  10800-temp; 
 421   2      
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 8   

 422   2          ftemp = (float)temp/108;
 423   2      
 424   2          gstAM901.Run.Bit.FlowResidualPercent = (u8)ftemp;
 425   2        }
 426   1        else if(gstFilte.type == MixFilter && PunpFlag)
 427   1        {
 428   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 429   2            FilterlifeTime();;
*** WARNING C209 IN LINE 429 OF ..\Apps\sysRun.c: '_FilterlifeTime': too few actual parameters
 430   2            
 431   2          
 432   2      
 433   2            
 434   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 435   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 436   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 437   2          
 438   2          if(temp >3600ul )
 439   2            temp = 3600ul;
 440   2          
 441   2          temp =  3600-temp;  
 442   2      
 443   2          ftemp = ((float)temp)/36;
 444   2            
 445   2          gstAM901.Run.Bit.FlowResidualPercent =  (u8)ftemp;
 446   2        }
 447   1      }
 448          
 449           
 450          
 451          /************************************************************************* 
 452          * 函数名称: DevicePowerOn
 453          * 功能说明: 设备上电初始化
 454          * 输    入: 无  
 455          * 输    出: 无
 456          *************************************************************************/
 457          volatile  u8 sDPOCnt =0;nt =0;
 458          void DevicePowerOnInit(void)
 459          {
 460   1        
 461   1        Blueled_io = 1;
 462   1        Redled_io = 1;
 463   1        Chanel_IO1 = 1;
 464   1        Chanel_IO2 = 1;
 465   1        led1_io = 0;
 466   1        led2_io = 0;
 467   1        led3_io = 0;
 468   1        led4_io = 0;
 469   1        //Buzzer2Flag = 1;
 470   1        //BuzzerProcess();
 471   1        PWM_IndependentModeConfig(PWM02,2000);
 472   1        while(1)
 473   1        {
 474   2          if(Ev100MSFlag)
 475   2          {
 476   3            WDTCON |=0x10;
 477   3            sDPOCnt++;
 478   3            Ev100MSFlag =0;
 479   3            
 480   3              
 481   3             if(sDPOCnt>= 30)
 482   3            {
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 9   

 483   4              break;
 484   4            }
 485   3            else if(sDPOCnt>= 2)
 486   3            {
 487   4              PWM_IndependentModeConfig(PWM02,0);
 488   4            }       
 489   3          }
 490   2        }
 491   1        Chanel_IO1 = 0;
 492   1        Chanel_IO2 = 0;
 493   1        led1_io = 0;
 494   1        led2_io = 0;
 495   1        led3_io = 0;
 496   1        led4_io = 0;
 497   1        Blueled_io = 0;
 498   1        Redled_io = 0;
 499   1      }
 500          
 501          /************************************************************************* 
 502          * 函数名称: FirstPowerOnProcess
 503          * 功能说明: 首次上电对设备清洗处理
 504          * 输    入: 无  
 505          * 输    出: 无
 506          *************************************************************************/
 507          void FirstPowerOnProcess(void)
 508          {
 509   1          static u16 sTimeCnt = 0;
 510   1          if(!FirstPownOnFlag)
 511   1          {
 512   2              return;
 513   2          } 
 514   1          sTimeCnt++;
 515   1          JinShuiFa_io = 1;
 516   1          Pump_io = 1;
 517   1          FeiShuiFa_IO = 1;
 518   1          KongShuiFa_IO = 1;
 519   1          
 520   1          if(sTimeCnt > _15Min_Per1S)
 521   1          {
 522   2              JinShuiFa_io = 0;
 523   2              Pump_io = 0;
 524   2              FeiShuiFa_IO = 0;
 525   2              KongShuiFa_IO = 0;
 526   2              FirstPownOnFlag =  1;
 527   2          }
 528   1              
 529   1          
 530   1      }
 531          /************************************************************************* 
 532          * 函数名称: RestFilter
 533          * 功能说明: 复位滤芯
 534          * 输    入: 无  
 535          * 输    出: 无
 536          *************************************************************************/
 537          void RestFilter(void)
 538          {
 539   1      
 540   1      }
 541          
 542          /************************************************************************* 
 543          * 函数名称: makeWaterProcess
 544          * 功能说明: 制作纯水
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 10  

 545          * 输    入: 无  
 546          * 输    出: 无
 547          *************************************************************************/
 548          
 549          
 550          void PaiShuiProcess(void)//1S钟运行一次
 551          {
 552   1        static u8 sTDS_Time =0;
 553   1        static u8 sPaiShuiFaOn_Cnt;
 554   1        
 555   1        test_TDS(gstADCollect.fChunShui,&gstADCollect.tds_ChunShui);
 556   1        test_TDS(gstADCollect.fYuanShui,&gstADCollect.tds_YuanShui);//检测10次求平均值
 557   1        test_TDS(gstADCollect.fJieShui,&gstADCollect.tds_JieShui);//检测10次求平均值
 558   1        test_TDS(gstADCollect.fLouShui,&gstADCollect.fLouShui);//检测10次求平均值
*** WARNING C182 IN LINE 558 OF ..\Apps\sysRun.c: pointer to different objects
 559   1        TDS_ChunShuiFalg = 1;
 560   1        if(sTDS_Time < 60)
 561   1        {
 562   2            TDS_YuanShuiFalg =1;
 563   2            
 564   2            if(gstADCollect.fYuanShui <= TDS_100)
 565   2            { 
 566   3              gstAM901.PaiShuiDaoJiShi = _9Min_Per1S;
 567   3            }
 568   2      
 569   2            else if(gstADCollect.fYuanShui <= TDS_300)
 570   2            {
 571   3              gstAM901.PaiShuiDaoJiShi = _8Min_Per1S;//KongShuiFa_IO = 1; 
 572   3            }
 573   2      
 574   2            else if(gstADCollect.fYuanShui <= TDS_500)
 575   2            {
 576   3              gstAM901.PaiShuiDaoJiShi = _4Min_Per1S;//KongShuiFa_IO = 1; 
 577   3            }
 578   2            else//上店10秒内TTDS <100
 579   2            {
 580   3              gstAM901.PaiShuiDaoJiShi  =0;//KongShuiFa_IO = 1; 
 581   3            }
 582   2        }
 583   1      
 584   1        if(sTDS_Time < 60)
 585   1        {
 586   2          sTDS_Time++;
 587   2        }   
 588   1        else
 589   1        {
 590   2          if(gstAM901.PaiShuiDaoJiShi > 0 && (gstAM901.PaiShuiDaoJiShi !=0xffff))
 591   2          {
 592   3            gstAM901.PaiShuiDaoJiShi--;
 593   3          }
 594   2          
 595   2          else
 596   2          {
 597   3            KongShuiFa_IO = 1;
 598   3            gstAM901.PaiShuiDaoJiShi =0xffff;
 599   3          }
 600   2          
 601   2          
 602   2          if(!KeySwitchFlag)//水满
 603   2          {
 604   3              KongShuiFa_IO = 0;
 605   3          }
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 11  

 606   2        }
 607   1        
 608   1      
 609   1      }
*** WARNING C280 IN LINE 553 OF ..\Apps\sysRun.c: 'sPaiShuiFaOn_Cnt': unreferenced local variable
 610          
 611          
 612          
 613          void MakeWaterProcess(void)
 614          {   
 615   1          static u8 sMWaterStep = 5;
 616   1          static u16 sMWaterStepCnt = 0;
 617   1      
 618   1          if(ErrowFlag||FactoryModeFlag || !SysRunFlag)
 619   1          {
 620   2            return ;
 621   2          }
 622   1        
 623   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 624   1          {
 625   2              return;
 626   2          } 
 627   1          
 628   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 629   1          {
 630   2            sMWaterStep =   0;
 631   2            MakeWaterFlag = 1;  
 632   2            HuiLiuFa_io = 0;
 633   2          }
 634   1      
 635   1          
 636   1        
 637   1          
 638   1          switch(sMWaterStep)
 639   1          {
 640   2              case 0:
 641   2                JinShuiFa_io =1;
 642   2                sMWaterStep =1;
 643   2                LED4_L =1;
 644   2                PunpFlag = 1;
 645   2                
 646   2              break;
 647   2              
 648   2              case 1://0.5秒后打开增压泵
 649   2                sMWaterStepCnt++;
 650   2                if(sMWaterStepCnt > _500MS_Per50MS)
 651   2                {
 652   3                  sMWaterStepCnt = 0;
 653   3                  Pump_io = 1;
 654   3                  sMWaterStep++;
 655   3                  ChuShuiFlag = 1;
 656   3                  
 657   3                }     
 658   2              break;
 659   2              
 660   2              case 2:
 661   2              
 662   2                if(!KeySwitchFlag)//水满
 663   2                {
 664   3                    if(!ErrowFlag)
 665   3                    {
 666   4                        gstAM901.LianXuZhiShuiCnt =0;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 12  

 667   4                    }             
 668   3                    sMWaterStep++;
 669   3                    LED4_L =0;
 670   3                }
 671   2      
 672   2                if(_20Min_Per50MS < gstAM901.LianXuZhiShuiCnt++)
 673   2                {
 674   3                  ChuShuiFlag = 0;
 675   3                  ErrowFlag =  1;
 676   3                  CloseFuZai();
 677   3                  setLED(3,RedColor ,blink,_4S_Per100MS);
 678   3                }
 679   2              break;
 680   2              
 681   2              case 3:
 682   2                JinShuiFa_io = 0;//关闭进水阀
 683   2                sMWaterStepCnt = 0;
 684   2                sMWaterStep++;
 685   2                MakeWaterFlag = 0;
 686   2              break;
 687   2              
 688   2              case 4://0.5秒后关闭獗
 689   2                sMWaterStepCnt++;
 690   2                
 691   2                if(sMWaterStepCnt > _500MS_Per50MS)
 692   2                {
 693   3                  sMWaterStepCnt = 0;
 694   3                  Pump_io = 0;
 695   3                  PunpFlag = 0;
 696   3                  sMWaterStep++;      
 697   3                  ChuShuiFlag = 0;
 698   3                }
 699   2              break;
 700   2              
 701   2              case 5://连续五分钟检测到水满，打开回流阀
 702   2                  
 703   2                  sMWaterStepCnt++;
 704   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 705   2                  {
 706   3                      sMWaterStepCnt = 0;
 707   3                      sMWaterStep++;    
 708   3                      
 709   3                  }
 710   2              break;
 711   2                  
 712   2              case 6:
 713   2                  sMWaterStepCnt++;
 714   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 715   2                  {
 716   3                      sMWaterStepCnt = 0;
 717   3                      sMWaterStep++;    
 718   3                      HuiLiuFa_io = 0;
 719   3                      Pump_io = 0;
 720   3                  }
 721   2                  else
 722   2                  {
 723   3                      HuiLiuFa_io = 1;
 724   3                      Pump_io = 1;//打开回流阀
 725   3                  }
 726   2                  if(KeySwitchFlag )
 727   2                    HuiLiuFa_io = 0;
 728   2              break;
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 13  

 729   2                  
 730   2              default:
 731   2              break;
 732   2              
 733   2              
 734   2            }
 735   1      }
 736          
 737          // TDS值校准
 738          
 739          void TDS_JiaoZhun(u16 v0,u16 AdValue_0,u16 v1,u16 AdValue_1)
 740          {
 741   1        float a,b;
 742   1      
 743   1        
 744   1          if(v0 > v1)
 745   1          {
 746   2            //  a = (v0- v1)*4095/((float)(AdValue_0-AdValue_1));
 747   2              a= (v0- v1);
 748   2              a= a*4095/(float)(AdValue_0-AdValue_1);
 749   2              b = AdValue_1/(float)4095;
 750   2              b = b*a;
 751   2              b =  v1- b;
 752   2          }
 753   1          else
 754   1          {
 755   2              
 756   2              
 757   2            
 758   2              a= (v1- v0);
 759   2              a= a*4095/(float)(AdValue_1-AdValue_0);
 760   2              b = AdValue_1/(float)4095;
 761   2              b = b*a;
 762   2              b =  v1- b;
 763   2              b= 0;
 764   2          }
 765   1        
 766   1      }
 767          
 768          
 769          /************************************************************************* 
 770          * 函数名称: sysRuning
 771          * 功能说明: 程序运行主体
 772          * 输    入: 无  
 773          * 输    出: 无
 774          *************************************************************************/
 775          extern void TDS_Calulate(void);
 776          extern  void KeyGaoYaSwitch(void);
 777          extern void KeyRest(void);
 778          extern void KeySelect(void);
 779          u16 gPPM1 = 110 ,gPPM2 = 50 ,gAD1 = 1420 ,gAD2 =1120;
 780          void sysRuning(void)
 781          { 
 782   1      
 783   1        EventCollect();
 784   1          switch(PopEvent())
 785   1          {    
 786   2          
 787   2              case ev5MS:       
 788   2                BuzzerProcess();  
 789   2                
 790   2              break;  
C51 COMPILER V9.59.0.0   SYSRUN                                                            04/03/2024 18:39:18 PAGE 14  

 791   2      
 792   2              
 793   2              case ev50MS:
 794   2              {
 795   3                  KeySelect();
 796   3                  KeyRest();
 797   3                  NoKeyProcess();
*** WARNING C206 IN LINE 797 OF ..\Apps\sysRun.c: 'NoKeyProcess': missing function-prototype
 798   3                  KeyGaoYaSwitch();
 799   3                  MakeWaterProcess(); 
 800   3                  
 801   3              }
 802   2              break;
 803   2              
 804   2              case ev100MS:
 805   2              {
 806   3                  
 807   3                  TimeReminder();
 808   3                  TDS_Calulate();
 809   3                  UART0_SendData(); 
 810   3                  LED_Process();  
 811   3              }
 812   2              break;
 813   2              
 814   2              case ev1S:
 815   2              {
 816   3                  TDS_JiaoZhun(gPPM1,gAD1,gPPM2,gAD2);
 817   3                  FilterSysRunTime();//滤芯寿命计算
 818   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 819   3                  FactoryProcess();
 820   3                  SysRunFlag =1;
 821   3                  PaiShuiProcess();
 822   3              }
 823   2              break;
 824   2         
 825   2              default:
 826   2              break;
 827   2          }
 828   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4021    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     49    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  7 WARNING(S),  0 ERROR(S)
