C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSRUN
OBJECT MODULE PLACED IN ..\Output\sysRun.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Apps\sysRun.c LARGE OMF2 OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X2800) IN
                    -CDIR(..\FWLib\SC95F_Lib\inc;..\User;..\IOT_DRIVER\XIAOMI;..\Drivers;..\Drivers\TKDriver\C;..\List\..\Apps;..\Apps) DEFIN
                    -E(SC95F8x1xB) DEBUG PRINT(..\List\sysRun.lst) TABS(2) OBJECT(..\Output\sysRun.obj)

line level    source

   1          
   2          //////min sys//////
   3          #include "globe.h"
   4          #include "clib.h"
   5          #include "sysRun.h"
   6          //////min sys//////
   7          
   8          //#include "key.h"
   9          //#include "bsp_Led.h"
  10          //#include "factory.h"
  11          //#include "FuncTab.h"
  12          #include "..\Apps\bsp_Led.h"
  13          #include "..\Apps\ioConfig.h"
  14          #include "string.h"
  15          
  16          #define CLOSE_ALL_LED()  gbFlagData[3].all=0;BlueLedFlag =0;RedLedtFlag =0
  17          #define OPEN_ALL_LED()   gbFlagData[3].all=0xff;BlueLedFlag =1;RedLedtFlag =1
  18          
  19          /*****************************************************
  20          *函数名称：void CMP_Init(uchar CMPIS, uchar CMPRF)
  21          *函数功能：模拟比较器初始化
  22          *入口参数：CMPIS=正端通道，CMPRF=负端电压
  23          *出口参数：void
  24          *****************************************************/
  25          void CMP_Init(void)
  26          {
  27   1        CMPCON = 0x86;   //开启模拟比较器电源 选择负端电压 vdd/3
  28   1        CMPCFG = 0x18;//正端选择1.5v   ，从正端电压小于负端电压到正端电压大于负端电压 产生中断  
  29   1          IE1 |= 0x20;
  30   1      }
  31          
  32          
  33          void sysRest(void)
  34          {
  35   1         memset(gbFlagData,0,5);
  36   1         memset(&gstFilte,0,sizeof(gstFilte));
  37   1         gstAM901.stFilter = &gstFilte;
  38   1      }
  39          
  40          typedef enum
  41          {
  42            ROFilter,
  43            MixFilter
  44          }emFilter;
  45          
  46          
  47          
  48          
  49          /************************************************************************* 
  50          * 函数名称: FilterlifeTime
  51          * 功能说明: 用于计算滤芯寿命剩余时间
  52          * 输    入: 无  
  53          * 输    出: 无
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 2   

  54          *************************************************************************/
  55          void FilterlifeTime(emFilter type)
  56          {
  57   1        if( type  == ROFilter)
  58   1        {
  59   2          
  60   2          gstFilte.RO_FlowRateCnt++;
  61   2        }
  62   1        else
  63   1        {
  64   2          gstFilte.Mix_FlowRate++;
  65   2        }
  66   1      
  67   1      }
  68          
  69          void TimeReminder(void)
  70          {
  71   1        static u8 sTimeReminderCnt =0;
  72   1        u8  temp =gstAM901.Run.Bit.DayResidualPercent;
  73   1        
  74   1        if(gstAM901.Run.Bit.DayResidualPercent < temp)
  75   1          temp = gstAM901.Run.Bit.DayResidualPercent;
  76   1          
  77   1        if( gstFilte.type  == ROFilter)
  78   1        {
  79   2          if(temp <1)//寿命到期
  80   2          {
  81   3              LED2_R =1;
  82   3              LED2_L =0;
  83   3          }
  84   2        
  85   2          else if(temp <3)//寿命快到期
  86   2          {
  87   3              if(sTimeReminderCnt < 5)
  88   3              {
  89   4                  LED2_R =1;
  90   4                  LED2_L =0;
  91   4              }
  92   3              else
  93   3              {
  94   4                  LED2_R =0;
  95   4                  LED2_L =0;
  96   4              }
  97   3              
  98   3              sTimeReminderCnt++;
  99   3              
 100   3              if(sTimeReminderCnt >= 10)
 101   3                sTimeReminderCnt = 0;
 102   3          }
 103   2          else
 104   2          {
 105   3              LED2_R =0;
 106   3              LED2_L =1;
 107   3          }
 108   2        }
 109   1        else
 110   1        {
 111   2          if(temp < 3)//寿命到期
 112   2          {
 113   3              LED1_R =1;
 114   3              LED1_L =0;
 115   3      
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 3   

 116   3          }
 117   2        
 118   2          else if(temp < 10)//寿命快到期
 119   2          {
 120   3              if(sTimeReminderCnt < 5)
 121   3              {
 122   4                  LED1_R =1;
 123   4                  LED1_L =0;
 124   4              }
 125   3              else
 126   3              {
 127   4                  LED1_R =0;
 128   4                  LED1_L =0;
 129   4              }
 130   3              
 131   3              sTimeReminderCnt++;
 132   3              
 133   3              if(sTimeReminderCnt >= 10)
 134   3                sTimeReminderCnt = 0;
 135   3          }
 136   2          else
 137   2          {
 138   3              LED1_R =0;
 139   3              LED1_L =1;
 140   3          }
 141   2        }
 142   1          
 143   1        
 144   1      }
 145          
 146          
 147          /************************************************************************* 
 148          * 函数名称: FilterSysRunTime
 149          * 功能说明: 用于滤芯寿命.单位秒
 150          * 输    入: 无  
 151          * 输    出: 无
 152          *************************************************************************/
 153          void FilterSysRunTime(void)
 154          {
 155   1        unsigned long  temp;
 156   1        if(gstFilte.type == ROFilter) 
 157   1        {
 158   2        //  if(gstFilte.RO_DayCnt < 0x058FD400?)//3600*24*365
 159   2          if(gstFilte.RO_DayCnt <0x01E13380 ) 
 160   2            gstFilte.RO_DayCnt++;
 161   2            
 162   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 163   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 164   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
 165   2          temp =  108000-temp;
 166   2          gstAM901.Run.Bit.DayResidualPercent =  (float)temp/1080;
 167   2        }
 168   1        else
 169   1        {
 170   2          
 171   2          //if(gstFilte.Mix_DayCnt < ??0x01E13380)//83270(10/2.63)*60*1080)
 172   2          if(gstFilte.Mix_DayCnt <0x01E13380 )
 173   2            gstFilte.Mix_DayCnt++;
 174   2            
 175   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 176   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 177   2          temp =  gstFilte.RO_DayCnt/864; //gstFilte.RO_DayCnt/0x00015180 *100;
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 4   

 178   2            
 179   2          gstAM901.Run.Bit.DayResidualPercent = ( (36000-temp)/365);
 180   2        }
 181   1      //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -////
 182   1      
 183   1        
 184   1        if(gstFilte.type == ROFilter && PunpFlag) 
 185   1        {
 186   2          if(gstFilte.RO_FlowRateCnt < 246388ul)//108000/(2.63/60)
 187   2            gstFilte.RO_FlowRateCnt++;
 188   2      
 189   2            
 190   2            
 191   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 2.63*60*10800 
 192   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 193   2          temp =  gstFilte.RO_FlowRateCnt*0.04384;//2.63/60
 194   2          
 195   2          if(temp >10800ul )
 196   2            temp = 10800ul;
 197   2      
 198   2          gstAM901.Run.Bit.DayResidualPercent = (10800-temp)/108;
 199   2        }
 200   1        else if(gstFilte.type == MixFilter && PunpFlag)
 201   1        {
 202   2          if(gstFilte.Mix_FlowRate < 82117ul)//3600/(2.63/60)
 203   2            gstFilte.Mix_FlowRate++;
 204   2            
 205   2          if(temp >3600ul )
 206   2            temp = 3600ul;
 207   2      
 208   2            
 209   2          // 气泵运行多少分钟代表一天 (10/2.63)-> 转换成S-> (10/2.63)*60-> 气泵运行总时间时间 ：(10/2.63)*60*365
 210   2          // 气泵1秒钟运行多少天：  tick */60*（10/2.63） 
 211   2          temp =  gstFilte.Mix_FlowRate*0.04384;//gstFilte.RO_DayCnt*2.63/60
 212   2            
 213   2          gstAM901.Run.Bit.DayResidualPercent =  (3600-temp)/36;
 214   2        }
 215   1      }
 216          
 217          
 218          
 219          /************************************************************************* 
 220          * 函数名称: DevicePowerOn
 221          * 功能说明: 设备上电初始化
 222          * 输    入: 无  
 223          * 输    出: 无
 224          *************************************************************************/
 225          volatile  u8 sDPOCnt =0;nt =0;
 226          void DevicePowerOnInit(void)
 227          {
 228   1        
 229   1        Blueled_io = 1;
 230   1        Redled_io = 1;
 231   1        Chanel_IO1 = 1;
 232   1        Chanel_IO2 = 1;
 233   1        led1_io = 0;
 234   1        led2_io = 0;
 235   1        led3_io = 0;
 236   1        led4_io = 0;
 237   1        //Buzzer2Flag = 1;
 238   1        //BuzzerProcess();
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 5   

 239   1        PWM_IndependentModeConfig(PWM02,2000);
 240   1        while(1)
 241   1        {
 242   2          if(Ev100MSFlag)
 243   2          {
 244   3            WDTCON |=0x10;
 245   3            sDPOCnt++;
 246   3            Ev100MSFlag =0;
 247   3            
 248   3              
 249   3              if(sDPOCnt>= 30)
 250   3            {
 251   4              break;
 252   4            }
 253   3            else if(sDPOCnt>= 2)
 254   3            {
 255   4              PWM_IndependentModeConfig(PWM02,0);
 256   4            }       
 257   3          }
 258   2        }
 259   1        Chanel_IO1 = 0;
 260   1        Chanel_IO2 = 0;
 261   1        led1_io = 0;
 262   1        led2_io = 0;
 263   1        led3_io = 0;
 264   1        led4_io = 0;
 265   1        Blueled_io = 0;
 266   1        Redled_io = 0;
 267   1      }
 268          
 269          /************************************************************************* 
 270          * 函数名称: FirstPowerOnProcess
 271          * 功能说明: 首次上电对设备清洗处理
 272          * 输    入: 无  
 273          * 输    出: 无
 274          *************************************************************************/
 275          void FirstPowerOnProcess(void)
 276          {
 277   1          static u16 sTimeCnt = 0;
 278   1          if(!FirstPownOnFlag)
 279   1          {
 280   2              return;
 281   2          } 
 282   1          sTimeCnt++;
 283   1          JinShuiFa_io = 1;
 284   1          Pump_io = 1;
 285   1          FeiShuiFa_IO = 1;
 286   1          KongShuiFa_IO = 1;
 287   1          
 288   1          if(sTimeCnt > _15Min_Per1S)
 289   1          {
 290   2              JinShuiFa_io = 0;
 291   2              Pump_io = 0;
 292   2              FeiShuiFa_IO = 0;
 293   2              KongShuiFa_IO = 0;
 294   2              FirstPownOnFlag =  1;
 295   2          }
 296   1              
 297   1          
 298   1      }
 299          /************************************************************************* 
 300          * 函数名称: makeWaterProcess
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 6   

 301          * 功能说明: 制作纯水
 302          * 输    入: 无  
 303          * 输    出: 无
 304          *************************************************************************/
 305          
 306          
 307          void MakeWaterProcess(void)
 308          {   
 309   1          static u8 sMWaterStep = 5;
 310   1          static u16 sMWaterStepCnt = 0;
 311   1        
 312   1          if(FirstPownOnFlag)//和首次上电初始化是互斥关系
 313   1          {
 314   2              return;
 315   2          } 
 316   1          
 317   1          if(KeySwitchFlag && !MakeWaterFlag)//检测到高压开关打开,若设备没有制水，则开始制水
 318   1          {
 319   2            sMWaterStep =   0;
 320   2            MakeWaterFlag = 1;  
 321   2            HuiLiuFa_io = 0;
 322   2          }
 323   1      
 324   1          
 325   1        
 326   1          
 327   1          switch(sMWaterStep)
 328   1          {
 329   2              case 0:
 330   2                JinShuiFa_io =1;
 331   2                sMWaterStep =1;
 332   2                LED4_L =1;
 333   2                PunpFlag = 1;
 334   2                
 335   2              break;
 336   2              
 337   2              case 1://0.5秒后打开增压泵
 338   2                sMWaterStepCnt++;
 339   2                if(sMWaterStepCnt > _500MS_Per50MS)
 340   2                {
 341   3                  sMWaterStepCnt = 0;
 342   3                  Pump_io = 1;
 343   3                  sMWaterStep++;
 344   3                }     
 345   2              break;
 346   2              
 347   2              case 2:
 348   2                if(!KeySwitchFlag)//水满
 349   2                {
 350   3                    sMWaterStep++;
 351   3                    LED4_L =0;
 352   3                }
 353   2              break;
 354   2              
 355   2              case 3:
 356   2                JinShuiFa_io = 0;//关闭进水阀
 357   2                sMWaterStepCnt = 0;
 358   2                sMWaterStep++;
 359   2                MakeWaterFlag = 0;
 360   2              break;
 361   2              
 362   2              case 4://0.5秒后关闭獗
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 7   

 363   2                sMWaterStepCnt++;
 364   2                if(sMWaterStepCnt > _500MS_Per50MS)
 365   2                {
 366   3                  sMWaterStepCnt = 0;
 367   3                  Pump_io = 0;
 368   3                  PunpFlag = 0;
 369   3                  sMWaterStep++;              
 370   3                }
 371   2              break;
 372   2              
 373   2              case 5://连续五分钟检测到水满，打开回流阀
 374   2                  
 375   2                  sMWaterStepCnt++;
 376   2                  if(sMWaterStepCnt >_5Min_Per50MS)
 377   2                  {
 378   3                      sMWaterStepCnt = 0;
 379   3                      sMWaterStep++;    
 380   3                      
 381   3                  }
 382   2              break;
 383   2                  
 384   2              case 6:
 385   2                  sMWaterStepCnt++;
 386   2                  if(sMWaterStepCnt >_1Min_Per50MS)//一分钟后关闭回流阀
 387   2                  {
 388   3                      sMWaterStepCnt = 0;
 389   3                      sMWaterStep++;    
 390   3                      HuiLiuFa_io = 0;
 391   3                      Pump_io = 0;
 392   3                  }
 393   2                  else
 394   2                  {
 395   3                      HuiLiuFa_io = 1;
 396   3                      Pump_io = 1;//打开回流阀
 397   3                  }
 398   2                  if(KeySwitchFlag )
 399   2                    HuiLiuFa_io = 0;
 400   2              break;
 401   2                  
 402   2              default:
 403   2              break;
 404   2              
 405   2              
 406   2            }
 407   1      }
 408          
 409          
 410          void JinShuiWorkProcess(void)
 411          {
 412   1          
 413   1      }
 414          
 415          /************************************************************************* 
 416          * 函数名称: sysRuning
 417          * 功能说明: 程序运行主体
 418          * 输    入: 无  
 419          * 输    出: 无
 420          *************************************************************************/
 421          void sysRuning(void)
 422          { 
 423   1      
 424   1        EventCollect();
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 8   

 425   1          switch(PopEvent())
 426   1          {    
 427   2      
 428   2          case ev3MS:
 429   2             LED_sCan();
 430   2          break; 
 431   2              
 432   2              case ev5MS:       
 433   2                BuzzerProcess();
 434   2             //ADCollectProcess();  //  
 435   2              break;  
 436   2          
 437   2              case ev20MS:
 438   2              {
 439   3                  
 440   3              }       
 441   2              break;
 442   2              
 443   2              case ev50MS:
 444   2              {
 445   3                  KeySelect();
*** WARNING C206 IN LINE 445 OF ..\Apps\sysRun.c: 'KeySelect': missing function-prototype
 446   3                  KeyRest();
*** WARNING C206 IN LINE 446 OF ..\Apps\sysRun.c: 'KeyRest': missing function-prototype
 447   3                  KeyGaoYaSwitch();
*** WARNING C206 IN LINE 447 OF ..\Apps\sysRun.c: 'KeyGaoYaSwitch': missing function-prototype
 448   3                  MakeWaterProcess();           
 449   3              }
 450   2              break;
 451   2              
 452   2              case ev100MS:
 453   2              {
 454   3                  LED_Process();  
 455   3                  TimeReminder();
 456   3                  ////EepromProcess();   
 457   3              }
 458   2              break;
 459   2              
 460   2              case ev1S:
 461   2              {
 462   3                  FilterSysRunTime();//滤芯寿命计算
 463   3                  FirstPowerOnProcess();//首次上电冲洗15分钟
 464   3              }
 465   2              break;
 466   2         
 467   2              default:
 468   2              break;
 469   2          }
 470   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1400    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      9       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
C51 COMPILER V9.59.0.0   SYSRUN                                                            03/22/2024 20:40:39 PAGE 9   

   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
